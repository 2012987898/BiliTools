"use strict";var t=require("path"),e=require("fs"),n=require("lodash"),o=require("axios"),a=require("nodemailer"),i=require("qs"),s=require("crypto-js");function c(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var l=r(t),u=r(e),d=c(o),g=r(a),f=r(s);async function m(t,e){if(!D.PUSHPLUS_TOKEN)return;const n=d.default.create({baseURL:"http://www.pushplus.plus",headers:{"content-type":"application/json"}}),o={token:D.PUSHPLUS_TOKEN,content:e,title:t};try{const{data:{msg:t,code:e}}=await n.post("/send",o);if(200!==e)return console.log("pushplus 发送消息失败"),void console.log(e,t)}catch(t){console.log("pushplus 发送消息出现异常"),console.log(t.message)}}async function y(t,e){var n;const o=null===(n=D.config.message)||void 0===n?void 0:n.email;if(!(o&&o.pass&&o.from&&o.host))return;const a=Number(o.port)||465;let i=g.createTransport({host:o.host,port:a,secure:465===a,auth:{user:o.from,pass:o.pass}}),s=await i.sendMail({from:`"BiliTools任务" <${o.from}>`,to:o.to,subject:t,text:e});console.log("邮件消息已发送: %s",s.messageId)}async function p(t,e){try{const n=D.MESSAGE_API;if(!n)return;const o=n.replace("{title}",t).replace("{text}",e);await d.default.get(o)}catch(t){}}const w=require("pako");function _(t){const e=D.BILI_API_DELAY;let n;n=1===e.length?1e3*e[0]:1e3*h(e[0]||2,e[1]||6),n=t||n;let o=(new Date).getTime()+parseInt(n,10);for(;(new Date).getTime()<o;);return new Promise((t=>{t("done")}))}const h=n.random;function v(){const t=new Date,e=t.getTime(),n=t.getTimezoneOffset()/60;return new Date(e+36e5*(n+8))}function I(t){const e=t||v(),n=e.getFullYear(),o=e.getMonth()+1;return 2===o?n%4==0&&n%100!=0||n%100==0?29:28:[4,6,9,11].includes(o)?30:31}const b=()=>{const t=process.env.BILI_SCF_CONFIG;if(!t)return null;try{return JSON.parse((t=>{try{let e=Buffer.from(t,"base64").toString("binary").split("").map((t=>t.charCodeAt(0))),n=w.inflate(new Uint8Array(e)),o=String.fromCharCode.apply(null,new Uint16Array(n));try{return unescape(o)}catch(t){return o}}catch(t){throw new Error("Error: 当前字符串不能被Gzip解密")}})(t))}catch{throw new Error("BILI_SCF_CONFIG 配置不正确")}};const T=function(){const e=(()=>{try{return require(t.resolve(process.cwd(),"./config/config.dev.json"))}catch{}return null})()||(()=>{try{return require("./config.json")}catch{}return null})()||(()=>{try{return require(t.resolve(process.cwd(),"./config/config.json"))}catch{}return null})()||b();if(null!=e&&e.cookie)return e;throw new Error("配置文件不存在或不正确！！！")}(),{cookie:C}=T;function S(t){return t?t.split("; ").map((t=>t.split("="))):[]}function E(t,e){return t?e&&0!==e.length?function(t){let e=Object.keys(t).reduce(((e,n)=>e+`${n}=${t[n]}; `),"");return e.substring(0,e.length-2||0)}(function(t,e){let n=S(null==e?void 0:e[0]).filter((t=>2===t.length)),o=S(t).concat(n).filter((t=>2===t.length)),a={};for(const t of o)a[t[0]]?a[t[0]]=t[1]:Object.defineProperty(a,t[0],{value:t[1],enumerable:!0,writable:!0});return a}(t,e)):t:""}function $(t,e){if(!t)return null;const n=`(?:^|)${e}=([^;]*)(?:;|$)`,o=t.match(n);return o?o[1]:null}function A(){return $(C,"bili_jct")||""}var x,L,N,O,k,B,M;function R(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function U(t){return null==t?void 0:t.map((t=>Number(t)))}T.message||(T.message={});class D{}R(D,"config",T),R(D,"COOKIE",T.cookie),R(D,"BILIJCT",A()),R(D,"NICKNAME",""),R(D,"USERID",Number($(C,"DedeUserID"))||0),R(D,"USER_AGENT",T.userAgent),R(D,"BILI_TARGET_COINS",null!==(x=T.targetCoins)&&void 0!==x?x:5),R(D,"biliApiDelay",T.apiDelay||[2,6]),R(D,"BILI_API_DELAY",Array.isArray(D.biliApiDelay)?D.biliApiDelay:[D.biliApiDelay]),R(D,"BILI_CUSTOMIZE_UP",U(T.customizeUp)||[]),R(D,"BILI_GIFT_UP",U(T.giftUp)||D.BILI_CUSTOMIZE_UP||[]),R(D,"BILI_TARGET_LEVEL",null!==(L=T.targetLevel)&&void 0!==L?L:6),R(D,"BILI_STAY_COINS",null!==(N=T.stayCoins)&&void 0!==N?N:0),R(D,"BILI_UPPER_ACC_MATCH",T.upperAccMatch||!0),R(D,"BILI_COIN_RETRY_NUM",T.coinRetryNum||4),R(D,"CHARGE_ID",T.chargeUpId||D.USERID),R(D,"CHARGE_PRESET_TIME",T.chargePresetTime||31),R(D,"PUSHPLUS_TOKEN",process.env.PUSHPLUS_TOKEN||(null===(O=T.message)||void 0===O?void 0:O.pushplusToken)),R(D,"MATCH_COINS",null!==(k=T.matchCoins)&&void 0!==k?k:5),R(D,"MATCH_SELECTION",null!==(B=T.matchSelection)&&void 0!==B?B:1),R(D,"MESSAGE_API",null===(M=T.message)||void 0===M?void 0:M.api);class P{}R(P,"money",0),R(P,"coinsTask",D.BILI_TARGET_COINS),R(P,"share",!1),R(P,"watch",!1),R(P,"appInfo","\n"),R(P,"currentStartFun",0),R(P,"bCoinCouponBalance",0),R(P,"vipType",0);class G{}R(G,"DAILY_TRIGGER_NAME","daily_bili_timer"),R(G,"HEART_TRIGGER_NAME","heart_bili_timer"),R(G,"DAILY_RUN_TIME","17:30:00-23:40:00"),R(G,"HEART_RUN_TIME","12:00:00-20:00:00"),R(G,"MS2DATE",864e5);const H=console.log;const j={"User-Agent":D.USER_AGENT||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.61 Safari/537.36 Edg/94.0.992.31","content-type":"application/x-www-form-urlencoded","accept-language":"accept-language: zh-CN,zh;q=0.9,en-GB;q=0.8,en;q=0.7"};let q;d.default.defaults.headers.Cookie=D.COOKIE,d.default.defaults.withCredentials=!0,d.default.defaults.headers["User-Agent"]=j["User-Agent"],d.default.defaults.headers["content-type"]=j["content-type"],d.default.defaults.headers["accept-language"]=j["accept-language"],function(t){t[t["应用程序不存在或已被封禁"]=-1]="应用程序不存在或已被封禁",t[t["Access Key错误"]=-2]="Access Key错误",t[t["API校验密匙错误"]=-3]="API校验密匙错误",t[t["调用方对该Method没有权限"]=-4]="调用方对该Method没有权限",t[t["账号未登录"]=-101]="账号未登录",t[t["账号被封停"]=-102]="账号被封停",t[t["积分不足"]=-103]="积分不足",t[t["硬币不足"]=-104]="硬币不足",t[t["验证码错误"]=-105]="验证码错误",t[t["账号非正式会员或在适应期"]=-106]="账号非正式会员或在适应期",t[t["应用不存在或者被封禁"]=-107]="应用不存在或者被封禁",t[t["未绑定手机?"]=-108]="未绑定手机?",t[t["未绑定手机"]=-110]="未绑定手机",t[t["csrf 校验失败"]=-111]="csrf 校验失败",t[t["系统升级中"]=-112]="系统升级中",t[t["账号尚未实名认证"]=-113]="账号尚未实名认证",t[t["请先绑定手机"]=-114]="请先绑定手机",t[t["请先完成实名认证"]=-115]="请先完成实名认证"}(q||(q={}));const J=t=>{var e,n;const o=(null===(e=t.headers)||void 0===e?void 0:e["set-cookie"])||[];D.COOKIE=E(D.COOKIE,o);const a=null===(n=t.data)||void 0===n?void 0:n.code,i=async()=>{console.log("运行结束：",q[a]),await async function(t,e){t=`Bili-${D.NICKNAME}-${t}`,await Promise.all([y(t,e).catch(console.log),m(t,e),p(t,e)])}(`异常：${q[a]}`,P.appInfo),process.exit(0)};switch(a){case q["账号未登录"]:case q["账号被封停"]:i();default:return t}},K=t=>function(t){var e=t.config;if(0===e.retry)return Promise.reject(t);e.retry||(e.retry=2);if(e.__retryCount=e.__retryCount||0,e.__retryCount>=e.retry)return Promise.reject(t);return e.__retryCount+=1,new Promise((function(t){setTimeout((function(){t(void 0)}),e.retryDelay||100)})).then((function(){return d.default(e)}))}(t);const z=d.default.create({baseURL:"https://account.bilibili.com"}),F=d.default.create({baseURL:"https://api.live.bilibili.com"}),W=d.default.create({baseURL:"https://api.bilibili.com"}),Y=d.default.create({baseURL:"https://manga.bilibili.com"}),V=d.default.create({baseURL:"https://api.vc.bilibili.com"}),Z=[W,V,z,Y,F];for(const t of Z)t.interceptors.response.use(J,K);async function X(t=3394945){const e=(new Date).getTime(),{data:n}=await F.get(`/xlive/web-room/v1/gift/bag_list?t=${e}&room_id=${t}`);return n}async function Q(t=1,e=10){const{data:n}=await F.get(`/fans_medal/v5/live_fans_medal/iApiMedal?page=${t}&pageSize=${e}`);return n}async function tt({ruid:t,gift_num:e,bag_id:n,gift_id:o,roomid:a}){const s=D.BILIJCT,c=s,r=i.stringify({gift_id:o,ruid:t,gift_num:e,bag_id:n,biz_id:a,rnd:(new Date).getTime(),send_ruid:0,storm_beat_id:0,metadata:"",price:0,visit_id:"",csrf:s,platform:"pc",biz_code:"Live",csrf_token:c,uid:D.USERID}),{data:l}=await F.post("/xlive/revenue/v1/gift/sendBag",r,{headers:{referer:"https://www.bilibili.com/"}});return l}async function et(){const{data:t}=await W.get("/x/web-interface/nav",{retry:3});return t}async function nt(){const{data:t}=await W.get("/x/web-interface/coin/today/exp");return t}const ot={silver2Coin:!0,liveSignTask:!0,addCoins:!0,mangaSign:!1,shareAndWatch:!0,supGroupSign:!1,liveSendMessage:!1,taskReward:!0,charging:!1,getVipPrivilege:!1,giveGift:!1,matchGame:!1};function at(t){const e=t.level_info,n=e.current_level;if(n>=D.BILI_TARGET_LEVEL&&(P.coinsTask=0),console.log("当前等级: ",e.current_level),n>=6)ot.shareAndWatch=!1,ot.addCoins=!1,console.log("已经满级,不需要再投币了,做个白嫖怪吧");else{const t=e.next_exp-e.current_exp;console.log(`距离升级还需要${t}经验,预计${function(t){if(D.BILI_TARGET_COINS<=0)return t/15;const e=10*D.BILI_TARGET_COINS+15,n=t/e,o=P.money/(D.BILI_TARGET_COINS-1);if(n<o)return Math.floor(n);const a=t-o*e;return Math.floor(a/25+o)}(t)}天`)}}async function it(t){try{var e;const{data:n}=await async function(){const{data:t}=await z.get("/site/getCoin");return t}();console.log("登录成功: ",t.uname),console.log("硬币余额: ",n.money||0),D.NICKNAME=function(t){const e=t.length;return e<=3?t:`${t[0]}**${t[e-1]}`}(t.uname),P.money=n.money||0,P.bCoinCouponBalance=(null===(e=t.wallet)||void 0===e?void 0:e.coupon_balance)||0,at(t),function(t){let e="";switch(P.vipType=t.vipType,t.vipType){case 0:e="无大会员";break;case 1:e="月度大会员";break;case 2:e="年度大会员"}0===t.vipStatus&&(e="无大会员"===e?e:e+"[已过期]"),console.log("大会员状态: ",e)}(t)}catch(t){console.log("获取硬币信息异常: ",t.message)}}async function st(t,e,n){const{data:o}=await W.post("/x/web-interface/coin/add",i.stringify({aid:t,multiply:e,selectLike:n,csrf:D.BILIJCT}));return o}async function ct(t=!0){try{const e=D.USERID;let n;n=t?await async function(t=1,e=50){const{data:n}=await W.get("/x/relation/tag",{params:{tagid:-10,pn:t,ps:e}});return n}():await async function(t,e=1,n=50,o="desc",a="attention"){const{data:i}=await W.get("/x/relation/followings",{params:{vmid:t,pn:e,ps:n,order:o,order_type:a}});return i}(e);const{data:o,message:a,code:i}=n;if(0===i&&o.length>0){await _();const{mid:t}=o[h(o.length-1)];return await ut(t)}return 0===o.length?{msg:"-1",data:{}}:{msg:t?`未获取到特别关注列表: ${i}-${a}`:`未获取到关注列表: ${i}-${a}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function rt(){const t=[1,3,4,5,160,22,119],e=t[h(t.length-1)];try{const{data:t,message:n,code:o}=await async function(t=1,e=3){const{data:n}=await W.get("/x/web-interface/ranking/region",{params:{rid:t,day:e}});return n}(e,3);if(0==o){const{aid:e,title:n,author:o}=t[h(t.length-1)];return{msg:"0",data:{aid:e,title:n,author:o}}}return{msg:`未获取到排行信息: ${o}-${n}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function lt(){const t=D.BILI_CUSTOMIZE_UP;if(0===t.length)return{msg:"-1",data:{}};const e=t[h(t.length-1)];return await ut(e)}async function ut(t){t=Number(t);try{const{message:e,data:n,code:o}=await async function(t,e=50){const{data:n}=await W.get("/x/v2/medialist/resource/list",{params:{direction:!1,mobi_app:"web",type:1,bvid:"",ps:e,biz_id:t}});return n}(t);if(0==o){let e=n.media_list;!0===D.BILI_UPPER_ACC_MATCH&&(e=e.filter((e=>{var n;return t===(null===(n=e.upper)||void 0===n?void 0:n.mid)})));const{id:o,title:a,upper:i}=e[h(e.length-1)];return{msg:"0",data:{aid:o,title:a,author:i.name}}}return{msg:`通过uid获取视频失败: ${o}-${e}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function dt(){let t;const e=[lt,ct,()=>ct(!1),rt];D.BILI_CUSTOMIZE_UP||e.shift(),e.splice(0,P.currentStartFun);for(let o=0;o<e.length;o++){var n;const a=e[o];if(t=await a(),"0"===t.msg)return t;let i=Number(null!==(n=D.BILI_COIN_RETRY_NUM)&&void 0!==n?n:4);for(i=i<1?1:i>8?8:i;i--;)if(await _(),t=await a(),"-1"===t.msg&&(i=0),"0"===t.msg)return t;i<=0&&(P.currentStartFun=o)}return{msg:"-1",data:{aid:0}}}async function gt(t,e){const{data:n}=await V.get("/link_setting/v1/link_setting/sign_in",{params:{group_id:t,owner_id:e}});return n}async function ft(){try{const{data:t,code:e,message:n}=await async function(){const{data:t}=await V.get("/link_group/v1/member/my_groups");return t}();return 0===e?(null==t?void 0:t.list)||[]:(console.log("获取自己的应援团异常失败: ",n),[])}catch(t){console.log("获取自己的应援团异常: ",t)}}const mt=["(⌒▽⌒)","（￣▽￣）","(=・ω・=)","(｀・ω・´)","(〜￣△￣)〜","(･∀･)","(°∀°)ﾉ","(￣3￣)","╮(￣▽￣)╭","_(:3」∠)_","( ´_ゝ｀)","←_←","→_→","(<_<)","(>_>)","(;¬_¬)","(ﾟДﾟ≡ﾟдﾟ)!?","Σ(ﾟдﾟ;)","Σ( ￣□￣||)","(´；ω；`)","（/TДT)/","(^・ω・^ )","(｡･ω･｡)","(●￣(ｴ)￣●)","ε=ε=(ノ≧∇≦)ノ","(´･_･`)","(-_-#)","（￣へ￣）","(￣ε(#￣) Σ","ヽ(`Д´)ﾉ","（#-_-)┯━┯","(╯°口°)╯(┴—┴","←◡←","( ♥д♥)","Σ>―(〃°ω°〃)♡→","⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄","(╬ﾟдﾟ)▄︻┻┳═一","･*･:≡(　ε:)","(汗)","(苦笑)"].concat("1","2","3","4","5","6","7","8","9","签到","哈哈");async function yt(){try{const{code:t,message:e,data:n}=await async function(t=1,e=256,n=1){const{data:o}=await F.get(`/xlive/app-ucenter/v1/fansMedal/panel?page=${t}&page_size=${e}&target_id=${n}`);return o}(1,256,D.USERID);return 0!==t?(console.error("获取勋章信息失败 ",t,e),null):n}catch(t){return console.error("获取勋章异常",t.message),null}}async function pt(t,e){const n=mt[h(mt.length-1)];try{const{code:o,message:a}=await async function(t,e){const n=D.BILIJCT,o=n;e||(e=h(10).toString());const{data:a}=await F.post("/msg/send",i.stringify({color:5566168,fontsize:25,mode:1,msg:e,rnd:Date.now(),roomid:t,bubble:0,csrf:n,csrf_token:o}));return a}(t,n);return 0===o||(11e3===o?(console.log(`【${e}】${t}-可能未开启评论`),!1):(console.log(`【${e}】${t}-发送失败`,a),console.error(o),!1))}catch(t){console.error("发送弹幕异常",t.message)}}async function wt(){try{const{data:t,message:e,code:n}=await et();if(0!==n)return void console.log("获取用户信息失败：",n,e);!function(t){var e;P.bCoinCouponBalance=(null===(e=t.wallet)||void 0===e?void 0:e.coupon_balance)||0}(t)}catch(t){console.log("获取用户信息异常：",t.message)}}var _t;!function(t){t[t["成功"]=4]="成功",t[t["低于20电池"]=-2]="低于20电池",t[t["B币不足"]=-4]="B币不足"}(_t||(_t={}));const ht=["棒","棒唉","棒耶","加油~","UP加油!","支持~","支持支持！","催更啦","顶顶","留下脚印~","干杯","bilibili干杯","o(*￣▽￣*)o","(｡･∀･)ﾉﾞ嗨","(●ˇ∀ˇ●)","( •̀ ω •́ )y","(ง •_•)ง",">.<","^_~"];async function vt(t){try{const e=function(t){switch(t){case 1:return"B 币券";case 2:return"大会员优惠券";default:return""}}(t),{code:n,message:o}=await async function(t=1){const{data:e}=await W.post("/x/vip/privilege/receive",i.stringify({csrf:D.BILIJCT,type:t}));return e}(t);let a="成功";return 0===n&&(a=`失败 ${o}`),console.log(`领取${e} ${a}`),!0}catch(t){console.log("领取权益出现异常：",t.message)}return!1}async function It(t){let e=0,n=!1;for(;!(n||(n=await vt(t),e>2));)e++;return n}const{BILI_GIFT_UP:bt}=D;let Tt=0;async function Ct(){try{const{data:{list:t}}=await X();return t.filter((t=>!![1,30607].includes(t.gift_id)&&(1e3*t.expire_at-(new Date).getTime())/G.MS2DATE<2))}catch(t){if(Tt)return null;await Ct(),Tt++}}async function St(t){try{const{data:{live_room:e}}=await async function(t){const{data:e}=await W.get(`https://api.bilibili.com/x/space/acc/info?mid=${t}&jsonp=jsonp`);return e}(t);if(await _(),e.roomStatus)return{roomid:e.roomid}}catch{}return{roomid:0}}const Et=D.BILIJCT,$t=Et;async function At(t,e,n,o){const a=i.stringify({is_fav:0,main_id:e,oid:t,detail_id:n,count:o,csrf:Et,csrf_token:$t}),{data:s}=await W.post("/x/esports/guess/add",a);return s}const{MATCH_SELECTION:xt,MATCH_COINS:Lt}=D;function Nt(){return P.money-Lt<D.BILI_TARGET_COINS&&(console.log(`需要保留${D.BILI_TARGET_COINS}个硬币，任务结束`),!0)}function Ot(t,e,n,o,a){const i=A(),s=i,c=[$(C,"LIVE_BUVID")||"","xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))];return{ua:D.USER_AGENT,id:[n,e,a,t],csrf_token:i,csrf:s,device:c,uname:o}}async function kt(){try{await async function(){const{data:t}=await d.default.get("https://api.live.bilibili.com/relation/v1/Feed/heartBeat");return t}()}catch{}}async function Bt(t){const{data:{area_id:e,parent_area_id:n,room_id:o}}=await async function(t){const{data:e}=await F.get(`/room/v1/Room/get_info?room_id=${t}&from=room`);return e}(t);return{room_id:o,area_id:e,parent_area_id:n}}async function Mt(t,e){const n={id:JSON.stringify(t.id),device:JSON.stringify(t.device),ts:(new Date).getTime(),is_patch:0,heart_beat:"[]",ua:t.ua,visit_id:"",csrf:t.csrf,csrf_token:t.csrf_token};try{const{data:o,code:a}=await async function(t){const{data:e}=await d.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E",i.stringify(t));return e}(n);if(0===a)return console.log(`进入【${t.uname}】的直播间`),e.v++,o}catch(t){console.error(t)}}async function Rt(t,e,n){if(n.v>6)return;const o={id:JSON.stringify(e.id),device:JSON.stringify(e.device),ets:t.timestamp,benchmark:t.secret_key,time:60,ts:(new Date).getTime(),ua:e.ua},a=function(t,e){const[n,o,a,i]=JSON.parse(t.id),[s,c]=JSON.parse(t.device),{ets:r,time:l,ts:u}=t,d={platform:"web",parent_id:n,area_id:o,seq_id:a,room_id:i,buvid:s,uuid:c,ets:r,time:l,ts:u},g=t.benchmark,m=["MD5","SHA1","SHA256","SHA224","SHA512","SHA384"];let y=JSON.stringify(d);for(const t of e)y=f[`Hmac${m[t]}`](y,g).toString(f.enc.Hex);return y}(o,t.secret_rule);try{const{data:t,code:s,message:c}=await async function(t){const{data:e}=await d.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X",i.stringify(t));return e}(Object.assign({visit_id:"",csrf:e.csrf,csrf_token:e.csrf_token,s:a},o));return 0===s?(console.log(`向【${e.uname}】发送第${n.v}次心跳`),n.v++):console.log(`向【${e.uname}】发送第${n.v}次心跳失败`,s,c),t}catch(t){console.error(t)}}async function Ut(t=1,e=10){try{const{code:n,message:o,data:a}=await Q(t,e);return 0!==n?(console.error("获取直播间失败 ",n,o),null):a}catch(t){return console.error("获取直播间异常",t.message),null}}async function Dt(t=!0){const e=await async function(){let t=0;try{var e,n;const{data:o,code:a}=await X();return 0!==a||(null===(e=o.list)||void 0===e?void 0:e.length)<=0?24:(null===(n=o.list)||void 0===n||n.forEach((e=>{if(30607===e.gift_id){const n=(1e3*e.expire_at-(new Date).getTime())/G.MS2DATE;n>6&&n<=7&&(t+=e.gift_num)}})),t>=24?0:24-t)}catch(t){}return 24}();let n;return t?n=await async function(){const{fansMedalList:t,pageinfo:e}=await Ut();let{totalpages:n}=e;if(n&&n>1){n=n>3?3:n;for(let e=2;e<=n;e++){const n=await Ut(e,10);t.push(...n.fansMedalList)}}return t}():({fansMedalList:n}=await Ut()),{fansMedalList:n,heartNum:e}}async function Pt(){console.log("----【直播心跳】----");const{heartNum:t,fansMedalList:e}=await Dt(),n=Math.ceil(t/(null==e?void 0:e.length));for(let o=0;o<n;o++)await Ht(e,t);console.log("完成")}async function Gt(t,e,n,o){if(!o.v||e[n])return new Promise((async a=>{await kt(),await _(500),0===o.v?e[n]=await Mt(t,o):e[n]=await Rt(e[n],t,o),a("done")}))}async function Ht(t,e){return new Promise((async n=>{const o=[];for(let n=0;n<6;n++){let a=0;if(a>=e)break;const i=t.length;for(let s=0;s<i&&!(a>=e);s++){const e=t[s],{roomid:i,uname:c}=e,{room_id:r,area_id:l,parent_area_id:u}=await Bt(i),d=Ot(r,l,u,c,n);await Gt(d,o,s,{v:n}),await _(2e3),a++}n<5&&await _(6e4-2e3*a)}n("done")}))}var jt={taskReward:async function(){console.log("----【每日任务完成情况】----");try{const{data:t,message:e,code:n}=await async function(){const{data:t}=await W.get("/x/member/web/exp/reward");return t}();await _();const{data:o}=await nt();if(0!=n)return void console.log("状态获取失败: ",n,e);const a=P.money-D.BILI_STAY_COINS;let i=0;0===P.coinsTask?console.log(`今日投币获取经验: ${o}，还需投币0颗，经验够了,不想投了`):a<=0?console.log(`今日投币获取经验: ${o}，还需投币0颗，硬币不够了,不投币了`):a<P.coinsTask?(i=P.coinsTask-a,console.log(`投币获取经验: ${o}, 还需投币数量: ${i}颗;(目标${P.coinsTask}颗，忽略部分投币)`)):(i=P.coinsTask-o/10,console.log(`投币获取经验: ${o}, 还需投币数量: ${i}颗;(目标${P.coinsTask}颗)`)),P.coinsTask=i,console.log("每日分享: "+(t.share?"已完成":"[未完成]")),console.log("每日播放: "+(t.watch?"已完成":"[未完成]")),P.share=t.share,P.watch=t.watch}catch(t){console.log("状态获取异常",t.message)}},liveSignTask:async function(){console.log("----【直播签到】----");try{const{data:t}=await async function(){const{data:t}=await F.get("/xlive/web-ucenter/v1/sign/WebGetSignInfo");return t}();if(1===t.status)return console.log("已签到,跳过签到"),void console.log(`已经签到${t.hadSignDays}天,${t.specialText}`)}catch(t){}try{const{code:t,data:e,message:n}=await async function(){const{data:t}=await F.get("/xlive/web-ucenter/v1/sign/DoSign");return t}();0===t?console.log(`直播签到成功: ${e.text}, 特别信息: ${e.specialText}, 本月签到天数: ${e.hadSignDays}天;`):console.log("直播签到失败: ",t,n)}catch(t){console.log("直播签到异常: ",t.message)}},shareAndWatch:async function(){if(console.log("----【分享/播放视频】----"),P.share&&P.watch)return void console.log("已完成,跳过分享/播放");let t=0;try{let e=await lt();if("-1"===e.msg&&(e=await rt()),"0"!==e.msg)return console.log("获取视频失败",e.msg),!1;{const{aid:n,author:o,title:a}=e.data;t=n,console.log(`获取视频: ${a} --up【${o}】`)}}catch(t){return console.log("获取视频出现异常: ",t.message),!1}if(!P.share){await _();try{const{code:e,message:n}=await async function(t){const e={csrf:D.BILIJCT,aid:t},{data:n}=await W.post("/x/web-interface/share/add",i.stringify(e));return n}(t);0===e?console.log("分享视频成功!"):console.log("分享视频失败: ",e,n)}catch(t){console.log("分享视频异常: ",t.message)}}if(!P.watch){await _();try{const{code:e,message:n}=await async function(t,e){const{data:n}=await W.post("/x/click-interface/web/heartbeat",i.stringify({aid:t,played_time:e}));return n}(t,h(4,60));0===e?console.log("播放视频成功!"):console.log("播放视频失败: ",e,n)}catch(t){console.log("播放视频异常: ",t.message)}}},silver2Coin:async function(){console.log("----【银瓜子兑换硬币】----");try{const{data:t,code:e,message:n}=await async function(){const{data:t}=await F.get("/xlive/revenue/v1/wallet/getStatus");return t}();if(0!=e&&console.log("获取瓜子详情失败",n),0===t.silver_2_coin_left)console.log("今日已兑换一次");else if(t.silver<700)console.log("兑换失败,你瓜子不够了");else{const{message:t}=await async function(){const{data:t}=await F.post("/xlive/revenue/v1/wallet/silver2coin",i.stringify({csrf_token:D.BILIJCT,csrf:D.BILIJCT}));return t}();console.log(t),await async function(){const{data:t}=await F.get("/xlive/revenue/v1/wallet/myWallet?need_bp=1&need_metal=1&platform=pc");return t}()}}catch(t){console.log("操作异常",t.message)}},addCoins:async function(){if(console.log("----【视频投币】----"),!P.coinsTask)return void console.log("跳过投币,今日已完成");let t,e=0,n=0;for(;P.coinsTask&&n<5;){try{const{data:t,code:e}=await nt();if(0==e){let e=D.BILI_TARGET_COINS-t/10;P.coinsTask=e>0?e:0}}catch(t){}if(P.coinsTask<=0||P.money<=0)break;const{data:o,msg:a}=await dt();if(null==o||!o.aid||"0"!=a){n++;continue}await _();const{aid:i,title:s,author:c}=o;try{const o=await st(i,1,1);if(0==o.code)P.money--,P.coinsTask--,e++,console.log(`给[${s}--up【${c}】]投币成功`);else{if(n++,-111===o.code||-104===o.code){console.log(i,o.message,"无法继续进行投币");break}if(console.log("给up投币失败 ",o.code,o.message),t===o.code)break;t=o.code}}catch(t){n++,console.log("投币异常 ",t.message)}finally{await _(1500)}}n>=5&&console.log("出现异常/错误5次，自动退出投币"),console.log(`一共成功投币${e}颗`),console.log(`硬币还剩${P.money}颗`)},mangaSign:async function(){console.log("----【漫画签到】----");try{const{code:t}=await async function(t="android"){const{data:e}=await Y.post("/twirp/activity.v1.Activity/ClockIn",i.stringify({platform:t}));return e}();0==t?console.log("漫画签到成功"):console.log("漫画签到失败")}catch(t){400===t.response.status?console.log("已经签到过了,跳过任务"):console.log("漫画签到异常",t.message)}},supGroupSign:async function(){console.log("----【应援团签到】----");const t=await ft();await _();let e=0;for(let n=0;n<t.length;){let o=t[n];try{const{data:t,code:n,message:a}=await gt(o.group_id,o.owner_uid);0===n?0===t.status?e++:console.log(a):console.log(`[${o.group_name}]签到失败`,a)}catch(t){console.log("签到异常",t.message)}finally{await _()}}console.log(`签到结束，成功${e}/${t.length}`)},liveSendMessage:async function(){console.log("----【发送直播弹幕】----");const t=await async function(){const{list:t,special_list:e}=await yt();return t.push(...e),t}();let e=0,n=0;console.log(`一共需要发送${t.length}个直播间`),console.info("所需时间很长，请耐心等待");for(const o of t){const{room_info:t,anchor_info:a}=o;if(null==t||!t.room_id){console.log(`【${a.nick_name}】没有直播间哦`),n++;break}await pt(t.room_id,a.nick_name)&&e++,await _(h(1e4,25e3))}console.log(`成功发送${e}个弹幕,跳过${n}个`)},charging:async function(){if(console.log("----【给目标充电】----"),await wt(),await _(),function(){const t=v(),e=t.getDate(),n=I(t),o=D.CHARGE_PRESET_TIME;return P.bCoinCouponBalance<2?(console.log(`剩余券为${P.bCoinCouponBalance},不足2跳过投币`),!1):n===e?(console.log("今天是最后一天了"),!0):!(o>e&&(console.log(`预设时间为${o}，不符合条件`),1))}())try{const t=P.bCoinCouponBalance||0,e=D.CHARGE_ID;let o=0;console.log(`b 币券余额${t}`);const a=async()=>{const{code:o,message:a,data:s}=await async function(t=50,e=!0,n=D.USERID,o="up",a=n){const{data:s}=await W.post("/x/ugcpay/web/v2/trade/elec/pay/quick",i.stringify({csrf:D.BILIJCT,bp_num:t,is_bp_remains_prior:e,up_mid:n,otype:o,oid:a}));return s}(t,!0,e);0===o?(console.log("【充值结果】",_t[s.status]),s.status===_t["成功"]&&(P.chargeOrderNo=s.order_no,await _(),await async function(){try{if(!P.chargeOrderNo)return!1;const t=ht[n.random(0,ht.length-1)],{code:e}=await async function(t,e="支持大佬一波"){const{data:n}=await W.post("/x/ugcpay/trade/elec/message",i.stringify({csrf:D.BILIJCT,message:e,order_id:t}));return n}(P.chargeOrderNo,t);0===e&&console.log("留言成功！")}catch{}}())):console.log("充电失败：",o,a)};for(P.chargeOrderNo="";!(P.chargeOrderNo||(await a(),await _(),o++>2)););}catch(t){console.log("充电出现异常：",t.message)}},getVipPrivilege:async function(){console.log("----【领取大会员权益】----"),function(){if(2!==P.vipType)return console.log("账号非年度大会员，不需要领取权益"),!1;const t=v(),e=t.getDate(),n=I(t);return 1===e||n===e||(console.log("今天非预订领取时间，跳过领取"),!1)}()&&(await It(1),await It(2))},giveGift:async function(){console.log("----【投喂过期食物】----");try{const t=await Ct();if(await _(),null==t||!t.length)return void console.log("没有2天内过期的简单礼物");const{roomid:e,mid:o}=await async function(){const t=Object.assign([],bt),e=()=>t.splice(n.random(bt.length-1),1)[0];for(;t.length;){let t=e(),{roomid:n}=await St(t);if(n)return{roomid:n,mid:t}}return await async function(){const{data:{count:t,fansMedalList:e}}=await Q();if(await _(),!t)return{roomid:0,mid:0};const o=e[n.random(e.length-1)];return{mid:o.target_id,roomid:(null==o?void 0:o.roomid)||0}}()}();if(!e)return void console.log("没有找到投喂目标");await async function({roomid:t,mid:e},n){for(const o of n){await _();try{const{code:n,message:a,data:i}=await tt({roomid:t,ruid:e,bag_id:o.bag_id,gift_id:o.gift_id,gift_num:o.gift_num});0!==n?console.log(`给[ ${i.uname} ]投喂${i.gift_name}: `,a):console.log(`成功给[ ${i.uname} ]投喂${i.gift_num}${i.gift_name}`)}catch{}}}({roomid:e,mid:o},t)}catch(t){console.log("投喂过期食物异常",t)}},matchGame:async function(){if(console.log("----【赛事硬币竞猜】----"),Nt())return;const t=await async function(){try{const{code:t,message:e,data:{list:n,page:o}}=await async function(t="",e=""){const{data:n}=await W.get(`/x/esports/guess/collection/question?pn=1&ps=50&gid=&sids=&stime=${t}&etime=${e}`);return n}();return 0!==t?void console.log("获取赛事错误",t,e):0===o.total?(console.log("今日已经无法获取赛事"),null):n}catch(t){}}();if(await _(),!t)return;const e=await async function(t){let e=0;try{for(const n of t){const{contest:t,questions:o}=n,a=t.id,[{id:i,title:s,details:c,is_guess:r}]=o,[l,u]=c;if(Nt())return e;if(r)continue;console.log(`${s} <=> ${l.odds}:${u.odds}`);const d=l.odds>u.odds;let g;g=xt>0?d?u:l:d?l:u,console.log(`预测[ ${g.option} ] ${Lt} 颗硬币`),await _();const{code:f}=await At(a,i,g.detail_id,Lt);return 0!==f?console.log("预测失败"):(e++,P.money-=Lt),e}}catch(t){}return e}(t);console.log(`【竞猜结束】一共参与${e}次预测`)}};function qt(t){return function(){for(const t in ot)if(Object.prototype.hasOwnProperty.call(ot,t)){const e=ot[t];switch((D.config.function||{})[t]){case!0:!1===e&&(ot[t]=!0);break;case!1:!0===e&&(ot[t]=!1)}}ot.addCoins||ot.shareAndWatch||(ot.taskReward=!1)}(),t.map((t=>ot[t.name]?t:null)).filter((t=>t))}const{sendNotify:Jt}=require("./sendNotify");async function Kt(t,...e){try{await async function(){console.log("----【登录】----");try{const{data:t,message:e,code:n}=await et();if(65006===n||-404===n)return void console.log("登录错误",n,e);if(0!==n)return void console.log("登录错误",n,e);if(!t.isLogin)throw new Error("接口返回为未登录");await _(),await it(t)}catch(t){throw new Error(t.message)}}()}catch(t){return console.log("登录失败: ",t),await Jt(`Bili-${D.NICKNAME}-登录失败`,P.appInfo),"未完成"}const n=qt([...Object.values(jt)]);for(const t of n)await t(),await _();return t&&await t(...e),await Jt(`Bili-${D.NICKNAME}-任务完成`,P.appInfo),"完成"}(async()=>{var t;console.log=(t,...e)=>{let n=t;for(const t of e)n+=t;const o=(new Date).toISOString().match(/\w{2}:\w{2}:\w{2}/)[0],a=Number(o.split(":")[0])+8,i=(a>24?a-24:a<0?a+24:a).toString(),s=`[${(1===i.length?"0"+i:i)+o.replace(/^\w{2}/,"")}] `;H(s,t,...e),P.appInfo+=s+n+"\n"},function(){try{const t=u.readFileSync(l.resolve(__dirname,"../version.txt"),"utf8").trim();t&&console.log(`当前版本【${t}】`)}catch{}}(),null!==(t=D.config.function)&&void 0!==t&&t.liveHeart?await Kt(Pt):await Kt()})();
