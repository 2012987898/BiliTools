"use strict";var e=require("path"),t=require("pako"),n=require("fs"),i=require("json5"),r=require("nodemailer"),o=require("tunnel"),a=require("axios"),s=require("crypto");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function u(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var f=u(e),d=u(t),l=u(i),p=u(r),g=u(o),m=c(a),h=u(s);const _=["棒","棒唉","棒耶","加油~","UP加油!","支持~","支持支持！","催更啦","顶顶","留下脚印~","干杯","bilibili干杯","o(*￣▽￣*)o","(｡･∀･)ﾉﾞ嗨","(●ˇ∀ˇ●)","( •̀ ω •́ )y","(ง •_•)ง",">.<","^_~"],w=["舰","船","航海","代金券","优惠券","自拍","照","写真","图","提督","车车一局","再来一局","游戏道具"],v=["谢"],y=[65566781,1277481241,1643654862,603676925],$=Object.prototype.toString;function T(e,t){return $.call(e)===`[object ${t}]`}function I(e){return null!==e&&T(e,"Object")}function O(e){return T(e,"String")}function b(e){return"function"==typeof e}function C(e){const t=e||S(),n=t.getFullYear(),i=t.getMonth()+1;return 2===i?n%4==0&&n%100!=0||n%400==0?29:28:[4,6,9,11].includes(i)?30:31}function S(){const e=new Date,t=e.getTime(),n=e.getTimezoneOffset()/60;return new Date(t+36e5*(n+8))}function E(e,t){return Math.ceil(t/e)}function x(e,t,n){if(n&&"boolean"!=typeof n&&(t=n=void 0),void 0===n&&("boolean"==typeof t?(n=t,t=void 0):"boolean"==typeof e&&(n=e,e=void 0)),void 0===e&&void 0===t?(e=0,t=1):void 0===t&&(t=e,e=0),e>t){const n=e;e=t,t=n}if(n||e%1||t%1){const n=Math.random();return Math.min(e+n*(t-e+parseFloat("1e-"+((n+"").length-1))),t)}return e+Math.floor(Math.random()*(t-e+1))}function A(){return`${x(1,9)}${function(e,t){let n="";for(let t=0;t<e;t++)n+=B("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");return t?n.toLowerCase():n}(10,!0)}0`}function P(e,t){e.includes(t)||e.push(t)}function U(e){return e||{}}function L(e,t=!1){return"object"!=typeof e?e:Array.isArray(e)?e.map((e=>L(e,t))):t?Object.keys(e).reduce(((n,i)=>(n[i]=L(e[i],t),n)),{}):Object.assign({},e)}function R(e,t){return void 0===e||void 0===t?e||t:I(e)&&I(t)?Array.isArray(e)&&Array.isArray(t)?e.concat(t):Object.keys(t).reduce(((n,i)=>(n[i]=R(e[i],t[i]),n)),e):t}function k(e){const t=new URLSearchParams;return Object.keys(e).forEach((n=>{t.append(n,String(e[n]))})),t.toString()}function B(e){return e[x(e.length-1)]}function N(e){return e?e.split("; ").map((e=>e.split("="))):[]}function G(e,t){return e?t&&0!==t.length?function(e){const t=Object.keys(e).reduce(((t,n)=>t+`${n}=${e[n]}; `),"");return t.substring(0,t.length-2||0)}(function(e,t){const n=N(null==t?void 0:t[0]).filter((e=>2===e.length)),i=N(e).concat(n).filter((e=>2===e.length)),r={};for(const e of i)r[e[0]]?r[e[0]]=e[1]:Object.defineProperty(r,e[0],{value:e[1],enumerable:!0,writable:!0});return r}(e,t)):e:""}function D(e,t){if(!e)return null;const n=`(?:^|)${t}=([^;]*)(?:;|$)`,i=e.match(n);return i?i[1]:null}function q(e){return D(e,"bili_jct")||""}const H={value:""},M={log:j,error:function(e){j("error",e)},warn:function(e){j("warn",e)},info:function(e){j("info",e)},verbose:function(e){j("verbose",e)},debug:function(e){j("debug",e)}};function j(e,t){const n=S().toString().match(/\w{2}:\w{2}:\w{2}/)[0];if(function(e="debug"){const t=["error","warn","info","verbose","debug"],n=t.indexOf(e);return n>0?t.slice(0,n+1):t}().includes(e)){const e=`[${n}] ${t}`;H.value+=e+"\n"}process.stdout.write(`[${e} ${n}] ${t}\n`)}const K=()=>"QingLong"===process.env.BARK_GROUP||"/ql"===process.env.QL_DIR;class Y{static configFileName=function(){const e=K()?"cat_bili_config":"config",t=".json",{BILITOOLS_FILE_NAME:n}=process.env;return n?n.endsWith(t)?n:`${n}.json`:e+t}();static isQingLongPanel=K()}const J=l.default?l.default:l;function Q(e){try{let t;if((n.existsSync(e)||n.existsSync(e+="5"))&&(t=n.readFileSync(e,"utf-8")),!t)return;return M.verbose(`读取配置文件 ${e}`),J.parse(t)}catch(e){!function(e){if(!O(e))return;throw new TypeError("配置文件存在，但是无法解析！可能 JSON5 格式不正确！")}(e.message)}}const F=e=>f.resolve(process.cwd(),e),W=e=>f.resolve(__dirname,"../",e);function X(e){throw new Error(e||"获取配置失败！未找到配置文件！")}const z=Array.from(new Set([F("./config/config.dev.json"),F(`./config/${Y.configFileName}`),F(`./${Y.configFileName}`),W(`./config/${Y.configFileName}`),W(`./${Y.configFileName}`)])),V=["./config.json",F("./config/config.json")],Z=()=>{const{BILITOOLS_CONFIG:e,BILI_SCF_CONFIG:t,BILI_CONFIG:n}=process.env,i=e||t||n;if(i)try{return J.parse((e=>{try{const t=Buffer.from(e,"base64").toString("binary").split("").map((e=>e.charCodeAt(0))),n=d.inflate(new Uint8Array(t)),i=String.fromCharCode.apply(null,new Uint16Array(n));try{return decodeURIComponent(i)}catch(e){return i}}catch(e){throw new Error("Error: 当前字符串不能被Gzip解密")}})(i))}catch{X("环境中的配置不是有效的 JSON 字符串！")}};function ee(e){let t;const n=Array.isArray(e);if(t=n?e:e.account.filter((e=>e.cookie)),0===t.length)return;if(Y.isQingLongPanel)return function(e){const t=process.argv.find((e=>e.includes("--item")||e.includes("-i")||e.includes("-I")));if(!t)return e[0];const n=Number(t.split("=")[1])-1;return!n||n>=e.length||n<0?(M.warn("似乎想要指定一个不存在的用户，我们将指定第一个用户"),e[0]):e[n]}(t);M.warn("在单用户场景下配置了多用户，我们将放弃多余的配置");const i=t[0];return n||(i.message=Object.assign(e.message||{},i.message)),i}function te(){return ne(function(){if(globalThis.BILITOOLS_CONFIG)return globalThis.BILITOOLS_CONFIG;Y.isQingLongPanel&&z.splice(0,1,...V);for(let e=0;e<z.length;e++){const t=Q(z[e]);if(t)return t}return Z()}())}function ne(e){if(e||X(),function(e){if(Array.isArray(e))return!0;return Boolean(e.account&&e.account.length)}(e)){const t=ee(e);if(t)return t}return e.cookie||X("配置文件中没有 cookie！"),e}function ie(e){return e&&e.map((e=>Number(e))).filter((e=>e>0&&e%1==0))}class re{constructor(e){var t,n,i,r,o,a,s,c,u;this.config=e,this.COOKIE=e.cookie,this.BILIJCT=q(e.cookie),this.USERID=(u=e.cookie,Number(D(u,"DedeUserID"))||0),this.USER_AGENT=e.userAgent;const f=null!==(t=e.apiDelay)&&void 0!==t?t:[2,6];this.BILI_API_DELAY=Array.isArray(f)?ie(f):[Number(f)];const d=U(e.message);this.MESSAGE_API=d.api,this.PUSHPLUS_TOKEN=d.pushplusToken||process.env.PUSHPLUS_TOKEN;const l=U(e.coin);this.BILI_CUSTOMIZE_UP=ie(l.customizeUp||e.customizeUp)||[],this.BILI_UPPER_ACC_MATCH=!1!==(null!==(n=l.upperAccMatch)&&void 0!==n?n:e.upperAccMatch),this.BILI_COIN_RETRY_NUM=l.retryNum||e.coinRetryNum||4,this.BILI_TARGET_LEVEL=null!==(i=l.targetLevel||e.targetLevel)&&void 0!==i?i:6,this.BILI_STAY_COINS=null!==(r=l.stayCoins||e.stayCoins)&&void 0!==r?r:0,this.BILI_TARGET_COINS=null!==(o=l.targetCoins||e.targetCoins)&&void 0!==o?o:5;const p=U(e.gift);this.BILI_GIFT_UP=ie(p.mids||e.giftUp)||this.BILI_CUSTOMIZE_UP||[];const g=U(e.charge);this.CHARGE_ID=g.mid||e.chargeUpId||this.USERID,this.CHARGE_PRESET_TIME=g.presetTime||e.chargePresetTime||31;const m=U(e.match);this.MATCH_COINS=null!==(a=m.coins||e.matchCoins)&&void 0!==a?a:5,this.MATCH_SELECTION=null!==(s=m.selection||e.matchSelection)&&void 0!==s?s:1,this.MATCH_DIFF=null!==(c=m.diff||e.matchDiff)&&void 0!==c?c:0;const h=U(e.lottery);this.LOTTERY_EXCLUDE=h.excludeAward||w,this.LOTTERY_INCLUDE=h.includeAward||v,this.LOTTERY_UP_BLACKLIST=h.blackUid||y,this.LOTTERY_MOVE_TAG=h.moveTag,this.LOTTERY_PAGE_NUM=h.pageNum||2}}let oe;const ae=new Proxy({},{get:(e,t)=>(oe||ce(),Reflect.get(oe,t)),set:(e,t,n)=>"config"===t&&n?(ce(n),!0):Reflect.set(oe,t,n)});let se=null;function ce(e){e||(e=te()),oe=new re(ne(e)),se=class extends class{static money=0;static coinsTask=5;static share=!1;static watch=!1;static currentStartFun=0;static bCoinCouponBalance=0;static vipType=0;static userLevel=0}{},se.coinsTask=oe.BILI_TARGET_COINS}const ue={silver2Coin:!0,liveSignTask:!0,addCoins:!0,mangaSign:!1,shareAndWatch:!0,supGroupSign:!1,liveSendMessage:!1,taskReward:!0,charging:!1,getVipPrivilege:!1,giveGift:!1,matchGame:!1,liveLottery:!1};function fe(){return{...ue}}function de(e){const t=function(){const e=fe();for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const n=e[t];switch((ae.config.function||{})[t]){case!0:!1===n&&(e[t]=!0);break;case!1:!0===n&&(e[t]=!1)}}return e.addCoins||e.shareAndWatch||(e.taskReward=!1),e}();return e.map((e=>t[e.name]?e:null)).filter((e=>e))}function le(e){const t=ae.BILI_API_DELAY;let n;n=1===t.length?1e3*t[0]:1e3*x(t[0]||2,t[1]||6),n=e||n;const i=(new Date).getTime()+parseInt(n,10);for(;(new Date).getTime()<i;);return new Promise((e=>{e("done")}))}var pe;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e["应用程序不存在或已被封禁"]=-1]="应用程序不存在或已被封禁",e[e["Access Key错误"]=-2]="Access Key错误",e[e["API校验密匙错误"]=-3]="API校验密匙错误",e[e["调用方对该Method没有权限"]=-4]="调用方对该Method没有权限",e[e["账号未登录"]=-101]="账号未登录",e[e["账号被封停"]=-102]="账号被封停",e[e["积分不足"]=-103]="积分不足",e[e["硬币不足"]=-104]="硬币不足",e[e["验证码错误"]=-105]="验证码错误",e[e["账号非正式会员或在适应期"]=-106]="账号非正式会员或在适应期",e[e["应用不存在或者被封禁"]=-107]="应用不存在或者被封禁",e[e["未绑定手机?"]=-108]="未绑定手机?",e[e["未绑定手机"]=-110]="未绑定手机",e[e["csrf 校验失败"]=-111]="csrf 校验失败",e[e["系统升级中"]=-112]="系统升级中",e[e["账号尚未实名认证"]=-113]="账号尚未实名认证",e[e["请先绑定手机"]=-114]="请先绑定手机",e[e["请先完成实名认证"]=-115]="请先完成实名认证"}(pe||(pe={}));const ge="GET",me=new Map,he=e=>[e.method,e.url].join("&");class _e{addPending(e){this.removePending(e);const t=he(e);e.cancelToken||(e.cancelToken=new m.default.CancelToken((e=>{me.has(t)||me.set(t,e)})))}removeAllPending(){me.forEach((e=>{e&&b(e)&&e()})),me.clear()}removePending(e){const t=he(e);if(me.has(t)){const e=me.get(t);e&&b(e)&&e(),me.delete(t)}}reset(){me.clear()}}class we{constructor(e){const{requestOptions:t}=e;!1===t.withCredentials&&(e.withCredentials=!1),this.options=e,this.axiosInstance=m.default.create(e),this.setupInterceptors()}createAxiosInstance(e){this.axiosInstance=m.default.create(e)}getTransform(){return this.options.transform}getAxios(){return this.axiosInstance}configAxios(e){this.axiosInstance&&this.createAxiosInstance(e)}setHeaders(e){this.axiosInstance&&Object.assign(this.axiosInstance.defaults.headers,this.options.headers,e)}setupInterceptors(){const e=this.getTransform();if(!e)return;const{requsetInterceptors:t,requestInterceptorsCatch:n,responseInterceptors:i,responseInterceptorsCatch:r}=e,o=new _e;this.axiosInstance.interceptors.request.use((e=>{var n;const{headers:{ignoreCancelToken:r}}=e;return!(r||(null===(n=this.options.requestOptions)||void 0===n?void 0:n.ignoreCancelToken))&&o.addPending(e),b(i)&&(e=t(e,this.options)),e}),void 0),b(n)&&this.axiosInstance.interceptors.request.use(void 0,n),this.axiosInstance.interceptors.response.use((e=>(e&&o.removePending(e.config),b(i)&&(e=i(e)),e)),void 0),b(r)&&this.axiosInstance.interceptors.response.use(void 0,r)}supportFormData(e){var t;const n={...this.options.headers,...e.headers};return((null==n?void 0:n["Content-Type"])||(null==n?void 0:n["content-type"])||"").includes("application/x-www-form-urlencoded")&&Reflect.has(e,"data")&&(null===(t=e.method)||void 0===t?void 0:t.toUpperCase())!==ge&&!O(e.data)?{...e,data:k(e.data)}:e}get(e,t){return O(e)?this.request({...t,method:"GET",url:e}):this.request({...e,method:"GET"})}post(e,t,n){return O(e)?this.request({...n,method:"POST",url:e,data:t}):this.request({...e,method:"POST"})}put(e,t,n){return this.request({...n,method:"PUT",url:e,data:t})}delete(e,t,n){return this.request({...n,method:"DELETE",url:e,data:t})}patch(e,t,n){return this.request({...n,method:"PATCH",url:e,data:t})}request(e){let t=L(e,!0);const n=this.getTransform(),{requestOptions:i}=this.options,r=Object.assign({},i,e.requestOptions),{beforeRequestHook:o,requestCatchHook:a,transformRequestHook:s}=n||{};return b(o)&&(t=o(t,r)),t.requestOptions=r,t=this.supportFormData(t),new Promise(((e,n)=>{this.axiosInstance.request(t).then((t=>{if(b(s))try{const n=s(t,r);e(n)}catch(e){n(e||new Error("请求错误!"))}else e(t)})).catch((e=>{b(a)?n(a(e,r)):n(e)}))}))}}const ve="https://account.bilibili.com",ye="https://live.bilibili.com",$e="https://space.bilibili.com",Te="https://www.bilibili.com/",Ie="https://account.bilibili.com",Oe="https://api.live.bilibili.com",be="https://api.bilibili.com",Ce="https://manga.bilibili.com",Se="https://api.vc.bilibili.com",Ee={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.41 Safari/537.36 Edg/101.0.1210.32","content-type":"application/x-www-form-urlencoded; charset=UTF-8","accept-language":"zh-CN,zh;q=0.9"};var xe=[["/twirp/activity.v1.Activity/ClockIn","ERR_BAD_REQUEST"]];const Ae={transformRequestHook:(e,t)=>{const{isTransformResponse:n,isReturnNativeResponse:i}=t;if(i)return e;if(!n)return e.data;const{data:r}=e;return t.isJsonp&&O(r)?function(e){const t=e.replace(/^\w+\(/,"").replace(/\)$/,"");return JSON.parse(t)}(r):r},beforeRequestHook:(e,t)=>{var n;const{apiUrl:i}=t;i&&O(i)&&(e.url.startsWith("/")&&i.endsWith("/")?e.url=i+e.url.substring(1):e.url.startsWith("/")||i.endsWith("/")?e.url=`${i}${e.url}`:e.url=`${i}/${e.url}`);const r=e.params||{},o=e.data||!1;return(null===(n=e.method)||void 0===n?void 0:n.toUpperCase())!==ge&&(O(r)?(e.url=e.url+r,e.params=void 0):Reflect.has(e,"data")&&e.data?(e.data=o,e.params=r):(e.data=r,e.params=void 0)),e},requsetInterceptors:e=>{const{requestOptions:t}=e;return!0===t.withBiliCookie&&(e.headers.Cookie=ae.COOKIE),e},responseInterceptors:e=>{var t;e.config.requestOptions.withBiliCookie&&(ae.COOKIE=G(ae.COOKIE,(null===(t=e.headers)||void 0===t?void 0:t["set-cookie"])||[]));return e},responseInterceptorsCatch:async e=>{const{requestOptions:t,url:n}=e.config;return xe.find((t=>t[0]===n&&t[1]===e.code))||0===t.retry?Promise.reject(e):(t.retry||(t.retry=2),t.__retryCount=t.__retryCount||0,t.__retryCount>=t.retry?Promise.reject(e):(t.__retryCount+=1,await le(t.retryDelay||100),await Le.request(e.config)))}};function Pe(e){return new we(R({timeout:1e4,headers:{"Content-Type":Ee["content-type"],"User-Agent":Ee["user-agent"],"accept-language":Ee["accept-language"]},transform:Ae,requestOptions:{isReturnNativeResponse:!1,isTransformResponse:!0,ignoreCancelToken:!0,retry:2,withBiliCookie:!0},withCredentials:!0},e||{}))}const Ue=Pe({requestOptions:{withBiliCookie:!1}}),Le=Pe();function Re(){var e;const t=(null===(e=ae.config)||void 0===e?void 0:e.message)||{};["GOBOT_URL","GOBOT_TOKEN","GOBOT_QQ","SCKEY","QQ_SKEY","QQ_MODE","BARK_PUSH","BARK_SOUND","BARK_GROUP","TG_BOT_TOKEN","TG_USER_ID","TG_PROXY_AUTH","TG_PROXY_HOST","TG_PROXY_PORT","TG_API_HOST","DD_BOT_TOKEN","DD_BOT_SECRET","QYWX_KEY","QYWX_AM","IGOT_PUSH_KEY","PUSH_PLUS_TOKEN","PUSH_PLUS_USER"].forEach((e=>{const n=t[(i=e,i.toLowerCase().replace(/_(\w)/g,((e,t)=>t.toUpperCase())))]||t[e]||process.env[e];var i;n&&(process.env[e]=n)})),ae.PUSHPLUS_TOKEN&&(process.env.PUSH_PLUS_TOKEN=ae.PUSHPLUS_TOKEN),function(){process.env.PUSH_KEY&&(ke=process.env.PUSH_KEY);process.env.QQ_SKEY&&(Ve=process.env.QQ_SKEY);process.env.QQ_MODE&&(Ze=process.env.QQ_MODE);process.env.BARK_PUSH?(Be=process.env.BARK_PUSH.indexOf("https")>-1||process.env.BARK_PUSH.indexOf("http")>-1?process.env.BARK_PUSH:`https://api.day.app/${process.env.BARK_PUSH}`,process.env.BARK_SOUND&&(Ne=process.env.BARK_SOUND),process.env.BARK_GROUP&&(Ge=process.env.BARK_GROUP)):Be&&-1===Be.indexOf("https")&&-1===Be.indexOf("http")&&(Be=`https://api.day.app/${Be}`);process.env.TG_BOT_TOKEN&&(De=process.env.TG_BOT_TOKEN);process.env.TG_USER_ID&&(qe=process.env.TG_USER_ID);process.env.TG_PROXY_AUTH&&(je=process.env.TG_PROXY_AUTH);process.env.TG_PROXY_HOST&&(He=process.env.TG_PROXY_HOST);process.env.TG_PROXY_PORT&&(Me=process.env.TG_PROXY_PORT);process.env.TG_API_HOST&&(Ke=process.env.TG_API_HOST);process.env.DD_BOT_TOKEN&&(Ye=process.env.DD_BOT_TOKEN,process.env.DD_BOT_SECRET&&(Je=process.env.DD_BOT_SECRET));process.env.QYWX_KEY&&(Qe=process.env.QYWX_KEY);process.env.QYWX_AM&&(Fe=process.env.QYWX_AM);process.env.IGOT_PUSH_KEY&&(We=process.env.IGOT_PUSH_KEY);process.env.PUSH_PLUS_TOKEN&&(Xe=process.env.PUSH_PLUS_TOKEN);process.env.PUSH_PLUS_USER&&(ze=process.env.PUSH_PLUS_USER)}()}let ke="",Be="",Ne="",Ge="QingLong",De="",qe="",He="",Me="",je="",Ke="api.telegram.org",Ye="",Je="",Qe="",Fe="",We="",Xe="",ze="",Ve="",Ze="";async function et(e,t){var n;const i=null===(n=ae.config.message)||void 0===n?void 0:n.email;if(!(i&&i.pass&&i.from&&i.host))return;const r=Number(i.port)||465,o=p.createTransport({host:i.host,port:r,secure:465===r,auth:{user:i.from,pass:i.pass}}),a=await o.sendMail({from:`${e} <${i.from}>`,to:i.to,subject:e,headers:{"Content-Type":"text/plain; charset=utf-8"},text:t.replace(/\n/g,"\r\n")});M.info(`邮件消息已发送: ${a.messageId}`)}async function tt(e,t){try{const n=ae.MESSAGE_API;if(!n)return;const i=n.replace("{title}",e).replace("{text}",t);await Ue.get(i)}catch(e){M.info(`自定义接口消息发送失败: ${e}`),M.error(e)}}function nt(e,t,n=2100){return new Promise((i=>{if(ke){t=t.replace(/[\n\r]/g,"\n\n");const r={url:ke.includes("SCT")?`https://sctapi.ftqq.com/${ke}.send`:`https://sc.ftqq.com/${ke}.send`,params:`text=${e}&desp=${t}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};setTimeout((()=>{Ue.post(r).then((e=>{0===e.errno||0===e.data.errno?M.info("server酱发送通知消息成功🎉"):1024===e.errno?M.info(`server酱发送通知消息异常: ${e.errmsg}`):M.info(`server酱发送通知消息异常\n${JSON.stringify(e)}`)})).catch((e=>{M.info("发送通知调用API失败！！"),M.info(e)})).finally((()=>{i("")}))}),n)}else i("")}))}function it(e,t){return new Promise((n=>{if(Ve){const i={url:`https://push.xuthus.cc/${Ze}/${Ve}`,headers:{"Content-Type":"application/json"},data:{},params:{}};e=e.replace(/京豆/g,"豆豆"),t=(t=(t=t.replace(/京豆/g,"")).replace(/🐶/g,"")).replace(/红包/g,"H包"),"email"===Ze?i.data={t:e,c:t}:i.params=`${e}\n\n${t}`;const r=function(e){switch(e){case"send":return"个人";case"group":return"QQ群";case"wx":return"微信";case"ww":return"企业微信";case"email":return"邮件";default:return"未知方式"}};Ue.post(i).then((e=>{200===e.code?M.info(`酷推发送${r(Ze)}通知消息成功🎉`):400===e.code?M.info(`QQ酷推(Cool Push)发送${r(Ze)}推送失败：${e.msg}`):503===e.code?M.info(`QQ酷推出错，${e.message}：${e.data}`):M.info(`酷推推送异常: ${JSON.stringify(e)}`)})).catch((e=>{M.info(`发送${r(Ze)}通知调用API失败！！`),M.info(e)})).finally((()=>{n("")}))}else n("")}))}function rt(e,t,n={}){return new Promise((i=>{if(Be){const r={url:`${Be}/${encodeURIComponent(e)}/${encodeURIComponent(t)}?sound=${Ne}&group=${Ge}&${k(n)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};Ue.get(r).then((e=>{200===e.code?M.info("Bark APP发送通知消息成功🎉"):M.info(`Bark APP发送通失败：${e.message}`)})).catch((e=>{M.info("Bark APP发送通知调用API失败！！"),M.error(e)})).finally((()=>{i("")}))}i("")}))}function ot(e,t){return new Promise((n=>{if(De&&qe){const i={url:`https://${Ke}/bot${De}/sendMessage`,params:`chat_id=${qe}&text=${e}\n\n${t}&disable_web_page_preview=true`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};if(He&&Me){const e=g.httpsOverHttp({proxy:{host:He,port:+Me,proxyAuth:je}});Object.assign(i,{httpsAgent:e})}Ue.post(i).then((e=>{e.ok?M.info("Telegram发送通知消息成功🎉。"):400===e.error_code?M.info("请主动给bot发送一条消息并检查接收用户ID是否正确。"):401===e.error_code&&M.info("Telegram bot token 填写错误。")})).catch((e=>{M.info("telegram发送通知消息失败！！"),M.info(e)})).finally((()=>{n("")}))}else n("")}))}function at(e,t){return new Promise((n=>{const i={url:`https://oapi.dingtalk.com/robot/send?access_token=${Ye}`,data:{msgtype:"text",text:{content:` ${e}\n\n${t}`}},headers:{"Content-Type":"application/json"},timeout:15e3};if(Ye){if(Je){const e=require("crypto"),t=Date.now(),n=e.createHmac("sha256",Je);n.update(`${t}\n${Je}`);const r=encodeURIComponent(n.digest("base64"));i.url=`${i.url}&timestamp=${t}&sign=${r}`}Ue.post(i).then((e=>{0===e.errcode?M.info("钉钉发送通知消息成功🎉。"):M.info(`钉钉发送通知失败：${e.errmsg}`)})).catch((e=>{M.info("钉钉发送通知消息失败！！"),M.info(e)})),n("")}else n("")}))}function st(e,t){return new Promise((n=>{const i={url:`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${Qe}`,data:{msgtype:"text",text:{content:` ${e}\n\n${t}`}},headers:{"Content-Type":"application/json"},timeout:15e3};Qe&&Ue.post(i).then((e=>{0===e.errcode?M.info("企业微信发送通知消息成功🎉。"):M.info(`企业微信发送通知失败：${e.errmsg}`)})).catch((e=>{M.info("企业微信发送通知消息失败！！"),M.info(e)})).finally((()=>{n("")})),n("")}))}function ct(e){const t=Fe.split(",");if(t[2]){const n=t[2].split("|");let i="";for(let t=0;t<n.length;t++){const r="签到号 "+(t+1);e.match(r)&&(i=n[t])}return i||(i=t[2]),i}return"@all"}function ut(e,t){return new Promise((n=>{if(Fe){const i=Fe.split(","),r={url:"https://qyapi.weixin.qq.com/cgi-bin/gettoken",data:{corpid:`${i[0]}`,corpsecret:`${i[1]}`},headers:{"Content-Type":"application/json"},timeout:15e3};Ue.post(r).then((r=>{const o=t.replace(/\n/g,"<br/>"),a=JSON.parse(r).access_token;let s;switch(i[4]){case"0":s={msgtype:"textcard",textcard:{title:`${e}`,description:`${t}`,url:"https://github.com/whyour/qinglong",btntxt:"更多"}};break;case"1":s={msgtype:"text",text:{content:`${e}\n\n${t}`}};break;default:s={msgtype:"mpnews",mpnews:{articles:[{title:`${e}`,thumb_media_id:`${i[4]}`,author:"智能助手",content_source_url:"",content:`${o}`,digest:`${t}`}]}}}i[4]||(s={msgtype:"text",text:{content:`${e}\n\n${t}`}}),s={url:`https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=${a}`,data:{touser:`${ct(t)}`,agentid:`${i[3]}`,safe:"0",...s},headers:{"Content-Type":"application/json"}},Ue.post(s).then((e=>{0===e.errcode?M.info("成员ID:"+ct(t)+"企业微信应用消息发送通知消息成功🎉。"):M.info(`企业微信应用：${e.errmsg}`)})).catch((e=>{M.info("成员ID:"+ct(t)+"企业微信应用消息发送通知消息失败！！"),M.info(e)})).finally((()=>{n("")}))})).catch((e=>{M.error("企业微信应用消息发送通知消息失败！！")}))}else n("")}))}function ft(e,t,n={}){return new Promise((i=>{if(We){if(!new RegExp("^[a-zA-Z0-9]{24}$").test(We))return M.info("您所提供的IGOT_PUSH_KEY无效"),void i("");const r={url:`https://push.hellyw.com/${We.toLowerCase()}`,params:`title=${e}&content=${t}&${k(n)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};Ue.post(r).then((e=>{"string"==typeof e&&(e=JSON.parse(e)),0===e.ret?M.info("iGot发送通知消息成功🎉"):M.info(`iGot发送通知消息失败：${e.errMsg}`)})).catch((e=>{M.info("发送通知调用API失败！！"),M.info(e)})).finally((()=>{i("")}))}else i("")}))}function dt(e,t){return new Promise((n=>{if(Xe){t=t.replace(/[\n\r]/g,"<br>");const i={url:"https://www.pushplus.plus/send",params:{token:`${Xe}`,title:`${e}`,content:`${t}`,topic:`${ze}`},headers:{"Content-Type":" application/json"},timeout:15e3};Ue.post(i).then((e=>{200===e.code?M.info(`push+发送${ze?"一对多":"一对一"}通知消息完成。`):M.info(`push+发送${ze?"一对多":"一对一"}通知消息失败：${e.msg}`)})).catch((e=>{M.info(`push+发送${ze?"一对多":"一对一"}通知消息失败！！`),M.info(e)})).finally((()=>{n("")}))}else n("")}))}async function lt(e,t){M.info("----【消息推送】----"),e=`Bili-${se.nickname}-${e}`,await async function(e,t,n={},i="\n\n本通知 By：https://github.com/catlair/BiliTools"){Re(),t+=i,await Promise.all([nt(e,t),dt(e,t)]),await Promise.all([rt(e,t,n),ot(e,t),at(e,t),st(e,t),ut(e,t),ft(e,t,n),et(e,t),tt(e,t),it(e,t)])}(e,t,void 0,"")}const pt=Pe({baseURL:Ie,headers:{"User-Agent":ae.USER_AGENT}}),gt=Pe({baseURL:Oe,headers:{Referer:Te,"User-Agent":ae.USER_AGENT}}),mt=Pe({baseURL:be,headers:{Referer:Te,"User-Agent":ae.USER_AGENT}}),ht=Pe({baseURL:Ce,headers:{"User-Agent":ae.USER_AGENT}}),_t=Pe({baseURL:Se,headers:{"User-Agent":ae.USER_AGENT}});function wt(e=3394945){const t=(new Date).getTime();return gt.get(`/xlive/web-room/v1/gift/bag_list?t=${t}&room_id=${e}`)}function vt(e=1,t=10){return e>10&&(e=10),gt.get(`/xlive/app-ucenter/v1/user/GetMyMedals?page=${e}&page_size=${t}`)}function yt({ruid:e,gift_num:t,bag_id:n,gift_id:i,roomid:r}){const o=ae.BILIJCT,a=o,s={gift_id:i,ruid:e,gift_num:t,bag_id:n,biz_id:r,rnd:(new Date).getTime(),send_ruid:0,storm_beat_id:0,metadata:"",price:0,visit_id:"",csrf:o,platform:"pc",biz_code:"Live",csrf_token:a,uid:ae.USERID};return gt.post("/xlive/revenue/v2/gift/sendBag",s,{headers:{Origin:ye}})}function $t(){return mt.get("/x/web-interface/nav",{headers:{Origin:ve}})}function Tt(){return mt.get("/x/web-interface/coin/today/exp")}function It(e=1,t=50,n=-10){return mt.get("/x/relation/tag",{params:{tagid:n,pn:e,ps:t}})}function Ot(e,t){return mt.post("/x/relation/tags/addUsers?cross_domain=true",{fids:e,tagids:t,csrf:ae.BILIJCT},{headers:{Origin:$e}})}function bt(e){const t=e.level_info,n=t.current_level;if(n>=ae.BILI_TARGET_LEVEL&&(se.coinsTask=0),M.info(`当前等级: ${t.current_level}`),n>=6){const e=ae.config.function;e.shareAndWatch=!1,e.addCoins=!1,e.taskReward=!1,M.info("已经满级，不需要再投币了，做个白嫖怪吧")}else{const e=t.next_exp-t.current_exp;M.info(`距离升级还需要 ${e} 经验，预计 ${function(e){if(ae.BILI_TARGET_COINS<=0)return e/15;const t=10*ae.BILI_TARGET_COINS+15,n=e/t,i=se.money/(ae.BILI_TARGET_COINS-1);return n<i?Math.floor(n):(e-i*t)/25+i}(e).toFixed(2)} 天`)}}async function Ct(e){try{var t;const{data:n}=await pt.get("/site/getCoin");M.info(`登录成功: ${e.uname}`),M.info(`硬币余额: ${n.money||0}`),se.nickname=function(e){const t=e.length;return t<=3?e:`${e[0]}**${e[t-1]}`}(e.uname),se.money=n.money||0,se.userLevel=e.level_info.current_level,se.bCoinCouponBalance=(null===(t=e.wallet)||void 0===t?void 0:t.coupon_balance)||0,bt(e),function(e){let t="";switch(se.vipType=e.vipType,e.vipType){case 0:t="无大会员";break;case 1:t="月度大会员";break;case 2:t="年度大会员"}0===e.vipStatus&&(t="无大会员"===t?t:t+"[已过期]"),M.info(`大会员状态: ${t}`)}(e)}catch(e){M.error(`获取硬币信息异常: ${e.message}`),M.debug(e)}}function St(e,t,n=1){return mt.post("/x/web-interface/coin/add",{aid:e,multiply:t,selectLike:n,csrf:ae.BILIJCT})}function Et(e,t=1){return Le.post("https://www.bilibili.com/audio/music-service-c/web/coin/add",{sid:e,multiply:t,csrf:ae.BILIJCT})}const xt="video",At="audio",Pt="article";async function Ut(e=!0){try{const t=ae.USERID,{data:n,message:i,code:r}=await(e?function(e=1,t=50){return It(e,t,-10)}():function(e,t=1,n=50,i="desc",r="attention"){return mt.get("/x/relation/followings",{params:{vmid:e,pn:t,ps:n,order:i,order_type:r}})}(t)),o=e?n:n.list;if(!o||0===o.length)return{msg:"-1",data:{}};if(0===r){await le();const{mid:e}=B(o)||{};return await kt(e)}return{msg:e?`未获取到特别关注列表: ${r}-${i}`:`未获取到关注列表: ${r}-${i}`,data:{}}}catch(e){return{msg:e.message,data:{}}}}async function Lt(){const e=B([1,3,4,5,160,22,119]);try{const{data:t,message:n,code:i}=await function(e=1,t=3){return mt.get("/x/web-interface/ranking/region",{params:{rid:e,day:t}})}(e,3);if(0==i){const{aid:e,title:n,author:i}=B(t);return{msg:"0",data:{id:Number(e),title:n,author:i}}}return{msg:`未获取到排行信息: ${i}-${n}`,data:{}}}catch(e){return{msg:e.message,data:{}}}}async function Rt(){const e=ae.BILI_CUSTOMIZE_UP;return 0===e.length?{msg:"-1",data:{}}:await kt(B(e))}async function kt(e){try{const{code:t,data:n,message:i}=await function(e){return mt.get(`/x/space/navnum?mid=${e}`)}(e);if(t)return{msg:`通过uid获取视频失败: ${t}-${i}`,data:{}};await le();const{video:r,audio:o,article:a}=n,{type:s,page:c,index:u}=function([e,t,n]){const i=e+t+n;if(!i)return;const r=x(0,i-1);let o=r;if(r<e)return{type:xt,page:E(30,o+1),index:o%30};const a=e+t;return o=r-e,r<a?{type:At,page:E(30,o+1),index:o%30}:(o=r-a,{type:Pt,page:E(12,o+1),index:o%12})}([r,o,a]),f={[xt]:Bt,[At]:Nt,[Pt]:Gt},d=await f[s](e,c,u);return d.message?{msg:d.message,data:{}}:{msg:"0",data:d}}catch(e){return M.debug(e),{msg:e.message,data:{}}}}async function Bt(e,t,n){const{code:i,data:r,message:o}=await function(e,t=30,n=1,i=""){return mt.get("/x/space/arc/search",{params:{jsonp:"jsonp",order:"pubdate",keyword:i,pn:n,tid:0,ps:t,mid:e}})}(e,30,t);if(i)return{message:o};const{aid:a,title:s,author:c}=r.list.vlist[n];return{type:xt,id:a,title:s,author:c}}async function Nt(e,t,n){const{code:i,data:r,msg:o}=await function(e,t=30,n=1){return mt.get("/audio/music-service/web/song/upper",{params:{jsonp:"jsonp",order:1,pn:n,ps:t,uid:e}})}(e,30,t);if(i)return{message:o};const{data:a}=r,{id:s,uname:c,title:u}=a[n];return{type:At,id:s,title:u,author:c}}async function Gt(e,t,n){const{code:i,data:r,message:o}=await function(e,t=12,n=1){return mt.get("/x/space/article",{params:{callback:"__test",jsonp:"jsonp",sort:"publish_time",pn:n,ps:t,mid:e},requestOptions:{isJsonp:!0}})}(e,12,t);if(i)return{message:o};const{articles:a}=r,{id:s,title:c,author:{name:u}}=a[n];return{type:Pt,id:s,title:c,author:u,mid:e}}const Dt=function(){const e=[Rt,Ut,()=>Ut(!1),Lt];return ae.BILI_CUSTOMIZE_UP||e.shift(),e}();async function qt(e=0){Dt.splice(0,se.currentStartFun+e);for(let e=0;e<Dt.length;e++){var t;const n=Dt[e];let i=Number(null!==(t=ae.BILI_COIN_RETRY_NUM)&&void 0!==t?t:4);for(i=i<1?1:i>8?8:i;i--;){await le();const e=await n();if("-1"===e.msg&&(i=0),"0"===e.msg)return e}i<=0&&(se.currentStartFun=e)}return{msg:"-1",data:{id:0}}}async function Ht({id:e,coin:t=1,type:n="video",mid:i}){const r={[xt]:St,[At]:Et,[Pt]:(e,t=1)=>function(e,t,n=1){return mt.post("/x/web-interface/coin/add",{aid:t,upid:e,avtype:2,multiply:n,csrf:ae.BILIJCT})}(i,e,t)},o=await r[n](Number(e),t);return{code:o.code,message:o.message||o.msg}}async function Mt(e){if(await async function(){try{const{data:e,code:t}=await Tt();if(0==t){const t=ae.BILI_TARGET_COINS-e/10;se.coinsTask=t>0?t:0}}catch(e){}}(),se.coinsTask<=0||se.money<=0)return!0;const{data:t,msg:n}=await qt(e.priority);return null!=t&&t.id&&"0"==n?(await le(),await async function(e,t){const{id:n,title:i,author:r,type:o,mid:a}=e;try{const e=await Ht({id:n,type:o,mid:a});if(0===e.code)se.money--,se.coinsTask--,t.num++,M.info(`给[${i}--up【${r}】]投币成功`);else if(34005===e.code)t.fillCount++,M.verbose(`当前稿件[${n}]不能再投币了`),t.fillCount>=3&&(M.warn("自定义用户组投币似乎没有币可投了"),t.priority++);else{if(-111===e.code||-104===e.code)return M.warn(`${n} ${e.message} 无法继续进行投币`),!0;if(t.eCount++,M.warn(`给${n}投币失败 ${e.code} ${e.message}`),t.prevCode===e.code)return!0;t.prevCode=e.code}}catch(e){t.eCount++,M.error(`投币异常 ${e.message}`)}finally{await le(1500)}return!1}(t,e)):(e.eCount++,!1)}async function jt(){try{const{data:e,code:t,message:n}=await _t.get("/link_group/v1/member/my_groups");return 0===t?(null==e?void 0:e.list)||[]:(M.warn(`获取自己的应援团异常失败: ${n}`),[])}catch(e){M.error(`获取自己的应援团异常: ${e}`)}}const Kt=["(⌒▽⌒)","（￣▽￣）","(=・ω・=)","(｀・ω・´)","(〜￣△￣)〜","(･∀･)","(°∀°)ﾉ","(￣3￣)","╮(￣▽￣)╭","_(:3」∠)_","( ´_ゝ｀)","←_←","→_→","(<_<)","(>_>)","(;¬_¬)","(ﾟДﾟ≡ﾟдﾟ)!?","Σ(ﾟдﾟ;)","Σ( ￣□￣||)","(´；ω；`)","（/TДT)/","(^・ω・^ )","(｡･ω･｡)","(●￣(ｴ)￣●)","ε=ε=(ノ≧∇≦)ノ","(´･_･`)","(-_-#)","（￣へ￣）","(￣ε(#￣) Σ","ヽ(`Д´)ﾉ","（#-_-)┯━┯","(╯°口°)╯(┴—┴","←◡←","( ♥д♥)","Σ>―(〃°ω°〃)♡→","⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄","(╬ﾟдﾟ)▄︻┻┳═一","･*･:≡(　ε:)","(汗)","(苦笑)"].concat("1","2","3","4","5","6","7","8","9","签到","哈哈");async function Yt(){try{const{code:e,message:t,data:n}=await function(e=1,t=256,n=1){return gt.get(`/xlive/app-ucenter/v1/fansMedal/panel?page=${e}&page_size=${t}&target_id=${n}`)}(1,256,ae.USERID);return 0!==e?(M.verbose(`获取勋章信息失败 ${e} ${t}`),null):n}catch(e){return M.error(`获取勋章异常 ${e.message}`),null}}async function Jt(e,t){const n=Kt[x(Kt.length-1)];try{const{code:i,message:r}=await function(e,t){const n=ae.BILIJCT,i=n;return t||(t=x(10).toString()),gt.post("/msg/send",{color:5566168,fontsize:25,mode:1,msg:t,rnd:Date.now(),roomid:e,bubble:0,csrf:n,csrf_token:i})}(e,n);return 0===i||(11e3===i?(M.warn(`【${t}】${e}-可能未开启评论`),!1):(M.warn(`【${t}】${e}-发送失败 ${r}`),M.verbose(`code: ${i}`),!1))}catch(e){M.verbose(`发送弹幕异常 ${e.message}`)}}async function Qt(){try{const{data:e,message:t,code:n}=await $t();if(0!==n)return void M.warn(`获取用户信息失败：${n} ${t}`);!function(e){var t;se.bCoinCouponBalance=(null===(t=e.wallet)||void 0===t?void 0:t.coupon_balance)||0}(e)}catch(e){M.error(`获取用户信息异常：${e.message}`)}}var Ft;async function Wt(e){try{const t=function(e){switch(e){case 1:return"B 币券";case 2:return"大会员优惠券";default:return""}}(e),{code:n,message:i}=await function(e=1){return mt.post("/x/vip/privilege/receive",{csrf:ae.BILIJCT,type:e})}(e);let r="成功";return 0===n&&(r=`失败 ${i}`),M.info(`领取${t} ${r}`),!0}catch(e){M.error(`领取权益出现异常：${e.message}`)}return!1}async function Xt(e){let t=0,n=!1;for(;!(n||(n=await Wt(e),t>2));)t++;return n}!function(e){e[e["成功"]=4]="成功",e[e["低于20电池"]=-2]="低于20电池",e[e["B币不足"]=-4]="B币不足"}(Ft||(Ft={}));let zt=0;async function Vt(){try{const{data:{list:e}}=await wt();return e.filter((e=>{if(e.expire_at<=0)return!1;const t=(1e3*e.expire_at-(new Date).getTime())/864e5<2,n=![1,30607].includes(e.gift_id);return n&&t&&M.info(`${e.gift_name} 即将过期请尽快投喂`),!n&&t}))}catch(e){if(zt)return null;await Vt(),zt++}}async function Zt(e){try{const{data:{live_room:t,name:n}}=await function(e){return mt.get(`/x/space/acc/info?mid=${e}&jsonp=jsonp`)}(e);if(await le(),t.roomStatus)return{roomid:t.roomid,name:n}}catch{}}function en(e,t,n,i){const r=ae.BILIJCT,o={is_fav:0,main_id:t,oid:e,detail_id:n,count:i,csrf:r,csrf_token:r};return mt.post("/x/esports/guess/add",o)}function tn(){return se.money-ae.MATCH_COINS<ae.BILI_TARGET_COINS&&(M.info(`需要保留${ae.BILI_TARGET_COINS}个硬币，任务结束`),!0)}function nn(e,t,n,i,r){const o=q(ae.COOKIE),a=o,s=[(c=ae.COOKIE,D(c,"LIVE_BUVID")||""),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))];var c;return{ua:ae.USER_AGENT,id:[n,t,r,e],csrf_token:o,csrf:a,device:s,uname:i}}async function rn(){try{await Le.get("https://api.live.bilibili.com/relation/v1/Feed/heartBeat")}catch{}}async function on(e){const{data:{area_id:t,parent_area_id:n,room_id:i}}=await function(e){return gt.get(`/room/v1/Room/get_info?room_id=${e}&from=room`)}(e);return{room_id:i,area_id:t,parent_area_id:n}}async function an(e,t){const n={id:JSON.stringify(e.id),device:JSON.stringify(e.device),ts:(new Date).getTime(),is_patch:0,heart_beat:"[]",ua:e.ua,visit_id:"",csrf:e.csrf,csrf_token:e.csrf_token};try{const{data:i,code:r}=await function(e){return Le.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E",e)}(n);if(0===r)return M.info(`进入【${e.uname}】的直播间`),t.v++,i}catch(e){M.verbose(e)}}async function sn(e,t,n){if(n.v>6)return;const i={id:JSON.stringify(t.id),device:JSON.stringify(t.device),ets:e.timestamp,benchmark:e.secret_key,time:60,ts:(new Date).getTime(),ua:t.ua},r=function(e,t){const[n,i,r,o]=JSON.parse(e.id),[a,s]=JSON.parse(e.device),{ets:c,time:u,ts:f}=e,d={platform:"web",parent_id:n,area_id:i,seq_id:r,room_id:o,buvid:a,uuid:s,ets:c,time:u,ts:f},l=e.benchmark,p=["MD5","SHA1","SHA256","SHA224","SHA512","SHA384"];let g=JSON.stringify(d);for(const e of t)g=h.createHmac(p[e],l).update(g).digest("hex");return g}(i,e.secret_rule);try{const{data:e,code:o,message:a}=await function(e){return Le.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X",e)}(Object.assign({visit_id:"",csrf:t.csrf,csrf_token:t.csrf_token,s:r},i));return 0===o?(M.info(`向【${t.uname}】发送第${n.v}次心跳`),n.v++):M.warn(`向【${t.uname}】发送第${n.v}次心跳失败 ${o} ${a}`),e}catch(e){M.verbose(e)}}async function cn(e=1,t=10){try{const{code:n,message:i,data:r}=await vt(e,t);return 0!==n?(M.verbose(`获取直播间失败 ${n} ${i}`),null):r}catch(e){return M.verbose(`获取直播间异常 ${e.message}`),null}}async function un(e=!0){const t=await async function(){let e=0;try{var t,n;const{data:i,code:r}=await wt();return 0!==r||(null===(t=i.list)||void 0===t?void 0:t.length)<=0?24:(null===(n=i.list)||void 0===n||n.forEach((t=>{if(30607===t.gift_id){const n=(1e3*t.expire_at-(new Date).getTime())/864e5;n>6&&n<=7&&(e+=t.gift_num)}})),e>=24?0:24-e)}catch(e){}return 24}();let n;return e?n=await async function(){const{items:e,page_info:t}=await cn();let{total_page:n}=t;if(n&&n>1){n=n>3?3:n;for(let t=2;t<=n;t++){const n=await cn(t,10);e.push(...n.items)}}return e}():({items:n}=await cn()),{fansMedalList:n,heartNum:t}}async function fn(e,t,n,i){if(!i.v||t[n])return await rn(),await le(500),0===i.v?t[n]=await an(e,i):t[n]=await sn(t[n],e,i),"done"}async function dn(e,t){const n=[];let i=0;for(let r=0;r<6;r++){let o=0;if(o>=t)break;const a=e.length;i=0;for(let s=0;s<a&&!(o>=t);s++){const t=(new Date).getTime(),a=e[s],{roomid:c,uname:u}=a,{room_id:f,area_id:d,parent_area_id:l}=await on(c),p=nn(f,d,l,u,r);await fn(p,n,s,{v:r}),await le(2e3),i+=(new Date).getTime()-t,o++}r<5&&await le(6e4-i)}return"done"}async function ln(e){const{data:t,code:n}=await mt.get("/x/relation/tags?jsonp=jsonp&callback=__jp3",{headers:{Referer:"https://space.bilibili.com/1/fans/follow?tagid=0"},requestOptions:{isJsonp:!0}});if(0===n)return t.find((t=>t.name===e));M.warn(`获取分组列表失败: ${n}`)}async function pn(e){const t=await ln(e);if(t)return t.tagid;await le(300);const{data:n,code:i,message:r}=await(o=e,mt.post("/x/relation/tag/create",{tag:o,jsonp:"jsonp",csrf:ae.BILIJCT}));var o;if(22106===i){await le(300);const t=await ln(e);return t&&t.tagid}return 0!==i&&M.warn(`创建分组失败: ${i}-${r}`),n.tagid}async function gn(e,t,n,i=1){if(e.length>t.length)return;const{data:r,code:o,message:a}=await It(i,20,0);if(0===o){for(const{mid:i,uname:o}of r){if(e.length>=t.length)return;if(i===n)return;(t.includes(i)||t.includes(o))&&e.push({mid:i,uname:o})}if(!(r.length<20))return await gn(e,t,n,i+1)}else M.warn(`获取关注用户失败: ${o}-${a}`)}const mn=0,hn=1,_n=5,wn=1,vn=504,yn=1096;let $n;async function Tn(){try{const{data:e,code:t,message:n}=await gt.get("/xlive/web-interface/v1/index/getWebAreaList?source_id=2");return 0!==t&&M.info(`获取直播分区失败: ${t}-${n}`),e.data.map((e=>e.list)).map((e=>e.map((e=>({areaId:e.id,parentId:e.parent_id})))))}catch(e){throw M.error(`获取直播分区异常: ${e.message}`),e}}async function In(e,t,n=1){try{await le(100);const{data:i,code:r,message:o}=await function(e,t,n=1){return gt.get(`/xlive/web-interface/v1/second/getList?platform=web&parent_area_id=${e}&area_id=${t}&page=${n}`)}(t,e,n);return 0!==r&&M.info(`获取直播间列表失败: ${r}-${o}`),function(e){const t=[],n=[];return e.forEach((e=>{const i=e.pendant_info[2];i&&(i.pendent_id===vn?t.push(e):i.pendent_id===yn&&n.push(e))})),{lotteryTime:t,lotteryPacket:n}}(i.list).lotteryTime}catch(e){throw M.error(`获取直播间列表异常: ${e.message}`),e}}async function On(e,t,n=1){const i=await In(e,t,n),r=[];for(const e of i){const t=await bn(e);t&&(r.push({...t,uid:e.uid,uname:e.uname}),await le(100))}return r}async function bn(e){if(ae.LOTTERY_UP_BLACKLIST.includes(e.uid))return void M.info(`跳过黑名单用户: ${e.uname}`);let t,n,i;try{({data:n,code:t,message:i}=await(r=e.roomid,gt.get(`/xlive/lottery-interface/v1/Anchor/Check?roomid=${r}`)))}catch(t){return void M.info(`直播间${e.roomid}检测异常: ${t.message}`)}var r;if(0!==t)return void M.debug(`直播间${e.roomid}检测失败: ${t}-${i}`);if(null===n)return;const o=ae.LOTTERY_EXCLUDE.some((e=>n.award_name.match(e)));if(!ae.LOTTERY_INCLUDE.some((e=>n.award_name.match(e)))&&o)M.info(`跳过屏蔽奖品: ${n.award_name}`);else if(n.status!==wn);else if(n.gift_price>0);else{if(n.require_type===mn||n.require_type===hn)return n;if(n.require_type===_n&&se.userLevel>=n.require_value)return n}}async function Cn(e){try{const{id:n,gift_id:i,gift_num:r,award_name:o,uid:a,uname:s,require_type:c,require_text:u}=e;M.info(`天选主播：【${s}】`),M.info(`奖品：${o}`);const{code:f,message:d}=await(t={id:n,gift_id:i,gift_num:r},gt.post("/xlive/lottery-interface/v1/Anchor/Join",{...t,csrf:ae.BILIJCT,csrf_token:ae.BILIJCT,visit_id:A(),platform:"pc"}));if(0!==f)return void M.info(`天选失败: ${f}-${d}`);if(M.info("天选成功 √"),c===hn){P($n,a);(function(e){const t=(e=e.replace("关注主播","")).split(/\s*\+\s*/);return t.shift(),t})(u).forEach((e=>P($n,e)))}}catch(e){M.info(`天选异常: ${e.message}`)}var t}async function Sn(e,t,n=2){for(let i=1;i<=n;i++){const n=await On(e,t,i);for(const e of n)await Cn(e),await le(300)}}var En={taskReward:async function(){M.info("----【每日任务完成情况】----");try{const{data:e,message:t,code:n}=await mt.get("/x/member/web/exp/reward");await le();const{data:i}=await Tt();if(0!=n)return void M.warn(`状态获取失败: ${n} ${t}`);const r=se.money-ae.BILI_STAY_COINS;let o=0;0===se.coinsTask?M.info(`今日投币获取经验: ${i}，还需投币0颗，经验够了，不想投了`):r<=0?M.info(`今日投币获取经验: ${i}，还需投币0颗，硬币不够了，不投币了`):r<se.coinsTask?(o=se.coinsTask-r,M.info(`投币获取经验: ${i}，还需投币数量: ${o}颗;(目标${se.coinsTask}颗，忽略部分投币)`)):(o=se.coinsTask-i/10,M.info(`投币获取经验: ${i}，还需投币数量: ${o}颗;(目标${se.coinsTask}颗)`)),se.coinsTask=o,M.info("每日分享: "+(e.share?"已完成":"[未完成]")),M.info("每日播放: "+(e.watch?"已完成":"[未完成]")),se.share=e.share,se.watch=e.watch}catch(e){M.error(`状态获取异常 ${e.message}`)}},liveSignTask:async function(){M.info("----【直播签到】----");try{const{data:e}=await gt.get("/xlive/web-ucenter/v1/sign/WebGetSignInfo");if(1===e.status)return M.info("已签到，跳过签到"),void M.info(`已经签到${e.hadSignDays}天，${e.specialText}`)}catch(e){}try{const{code:e,data:t,message:n}=await gt.get("/xlive/web-ucenter/v1/sign/DoSign");0===e?M.info(`直播签到成功: ${t.text}，特别信息: ${t.specialText}，本月签到天数: ${t.hadSignDays}天;`):M.warn(`直播签到失败: ${e} ${n}`)}catch(e){M.error(`直播签到异常: ${e.message}`)}},shareAndWatch:async function(){if(M.info("----【分享/播放视频】----"),se.share&&se.watch)return void M.info("已完成，跳过分享/播放");let e=0;try{let t=await qt();if("-1"===t.msg&&(t=await Lt()),"0"!==t.msg)return M.warn(`获取视频失败 ${t.msg}`),!1;{const{id:n,author:i,title:r}=t.data;e=n,M.info(`获取视频: ${r} --up【${i}】`)}}catch(e){return M.error(`获取视频出现异常: ${e.message}`),!1}if(!se.share){await le();try{const{code:t,message:n}=await function(e){const t={csrf:ae.BILIJCT,aid:e};return mt.post("/x/web-interface/share/add",t)}(e);0===t?M.info("分享视频成功!"):M.warn(`分享视频失败: ${t} ${n}`)}catch(e){M.error(`分享视频异常: ${e.message}`)}}if(!se.watch){await le();try{const{code:i,message:r}=await(t=e,n=x(4,60),mt.post("/x/click-interface/web/heartbeat",{aid:t,played_time:n}));0===i?M.info("播放视频成功!"):M.warn(`播放视频失败: ${i} ${r}`)}catch(e){M.error(`播放视频异常: ${e.message}`)}}var t,n},silver2Coin:async function(){M.info("----【银瓜子兑换硬币】----");try{const{data:e,code:t,message:n}=await gt.get("/xlive/revenue/v1/wallet/getStatus");if(0!=t&&M.info(`获取瓜子详情失败 ${n}`),0===e.silver_2_coin_left)M.info("今日已兑换一次");else if(e.silver<700)M.info("兑换失败，你瓜子不够了");else{const{message:e}=await gt.post("/xlive/revenue/v1/wallet/silver2coin",{csrf_token:ae.BILIJCT,csrf:ae.BILIJCT});M.info(`兑换硬币： ${e}`),await gt.get("/xlive/revenue/v1/wallet/myWallet?need_bp=1&need_metal=1&platform=pc")}}catch(e){M.error(`操作异常 ${e.message}`)}},addCoins:async function(){if(M.info("----【视频投币】----"),!se.coinsTask)return void M.info("跳过投币，今日已完成");const e={eCount:0,num:0,prevCode:0,fillCount:0,priority:0};let t=!1;for(;se.coinsTask&&!t&&e.eCount<5;)t=await Mt(e);e.eCount>=5&&M.info("出现异常/错误5次，自动退出投币"),M.info(`一共成功投币${e.num}颗`),M.info(`硬币还剩${se.money}颗`)},mangaSign:async function(){M.info("----【漫画签到】----");try{const{code:e}=await function(e="android"){return ht.post("/twirp/activity.v1.Activity/ClockIn",{platform:e})}();0==e?M.info("漫画签到成功"):M.warn("漫画签到失败")}catch(t){var e;400===(null===(e=t.response)||void 0===e?void 0:e.status)?M.info("已经签到过了，跳过任务"):M.error(`漫画签到异常 ${t.message}`)}},supGroupSign:async function(){M.info("----【应援团签到】----");const e=await jt();await le();let t=0;for(let r=0;r<e.length;){const o=e[r];try{const{data:e,code:r,message:a}=await(n=o.group_id,i=o.owner_uid,_t.get("/link_setting/v1/link_setting/sign_in",{params:{group_id:n,owner_id:i}}));0===r?0===e.status?t++:M.info(a):M.warn(`[${o.group_name}]签到失败 ${a}`)}catch(e){M.error(`签到异常 ${e.message}`)}finally{await le()}}var n,i;M.info(`签到结束，成功${t}/${e.length}`)},liveSendMessage:async function(){M.info("----【发送直播弹幕】----");const e=await async function(){const{list:e,special_list:t}=await Yt();return e.push(...t),e}(),t=e.length;let n=0,i=0;M.info(`一共需要发送${t}个直播间`),M.verbose("所需时间可能很长，请耐心等待");for(let r=0;r<t;r++){const{room_info:o,anchor_info:a,medal:s}=e[r];null!=o&&o.room_id?100===s.today_feed||s.guard_level>0?i++:(await Jt(o.room_id,a.nick_name)&&n++,r<t-1&&await le(x(1e4,25e3))):(M.info(`【${a.nick_name}】没有直播间哦`),i++)}M.info(`成功发送${n}个弹幕，跳过${i}个`)},charging:async function(){if(M.info("----【给目标充电】----"),await Qt(),await le(),function(){const e=S(),t=e.getDate(),n=C(e),i=ae.CHARGE_PRESET_TIME;return se.bCoinCouponBalance<2?(M.info(`剩余券为${se.bCoinCouponBalance}，不足2跳过充电`),!1):n===t?(M.info("今天是最后一天了"),!0):!(i>t&&(M.info(`预设时间为${i}，不符合条件`),1))}())try{const e=se.bCoinCouponBalance||0,t=ae.CHARGE_ID;let n=0;M.info(`b 币券余额${e}`);const i=async()=>{const{code:n,message:i,data:r}=await function(e=50,t=!0,n=ae.USERID,i="up",r=n){return mt.post("/x/ugcpay/web/v2/trade/elec/pay/quick",{csrf:ae.BILIJCT,bp_num:e,is_bp_remains_prior:t,up_mid:n,otype:i,oid:r})}(e,!0,t);0===n?(M.info(`【充值结果】${Ft[r.status]}`),r.status===Ft["成功"]&&(se.chargeOrderNo=r.order_no,await le(),await async function(){try{if(!se.chargeOrderNo)return!1;const e=_[x(0,_.length-1)],{code:t}=await function(e,t="支持大佬一波"){return mt.post("/x/ugcpay/trade/elec/message",{csrf:ae.BILIJCT,message:t,order_id:e})}(se.chargeOrderNo,e);0===t&&M.info("留言成功！")}catch{}}())):M.warn(`充电失败：${n} ${i}`)};for(se.chargeOrderNo="";!(se.chargeOrderNo||(await i(),await le(),n++>2)););}catch(e){M.error(`充电出现异常：${e.message}`)}},getVipPrivilege:async function(){M.info("----【领取大会员权益】----"),function(){if(2!==se.vipType)return M.info("账号非年度大会员，不需要领取权益"),!1;const e=S(),t=e.getDate(),n=C(e);return 1===t||n===t||(M.info("今天非预订领取时间，跳过领取"),!1)}()&&(await Xt(1),await Xt(2))},giveGift:async function(){M.info("----【投喂过期食物】----");try{const e=await Vt();if(await le(),null==e||!e.length)return void M.info("没有2天内过期的简单礼物");const t=await async function(){const e=Object.assign([],ae.BILI_GIFT_UP),t=()=>e.splice(x(ae.BILI_GIFT_UP.length-1),1)[0];for(;e.length;){const e=t(),n=await Zt(e);if(n)return{mid:e,...n}}return await async function(){const{data:{count:e,items:t}}=await vt();if(await le(),!e)return;const n=t[x(t.length-1)];return{mid:n.target_id,roomid:n.roomid||0,name:n.uname}}()}();if(!t)return void M.info("没有找到投喂目标");await async function({roomid:e,mid:t,name:n},i){for(const r of i){await le();try{const{code:i,message:o,data:a}=await yt({roomid:e,ruid:t,bag_id:r.bag_id,gift_id:r.gift_id,gift_num:r.gift_num});if(0!==i){M.warn(`向[${n}]投喂[${r.gift_name}]，${o}`);continue}a.gift_list.forEach((e=>{M.info(`成功给 [${n}] 投喂${e.gift_name}`)}))}catch{}}}(t,e)}catch(e){M.info(`投喂过期食物异常 ${e}`)}},matchGame:async function(){if(M.info("----【赛事硬币竞猜】----"),ae.MATCH_COINS<=0)return void M.info("硬币数量不能小于 0");if(tn())return;const e=await async function(){try{const{code:e,message:t,data:{list:n,page:i}}=await function(e="",t=""){return mt.get(`/x/esports/guess/collection/question?pn=1&ps=50&gid=&sids=&stime=${e}&etime=${t}`)}();return 0!==e?void M.warn(`获取赛事错误 ${e} ${t}`):0===i.total?(M.info("今日已经无法获取赛事"),null):n}catch(e){}}();if(await le(),!e)return;const t=await async function(e){let t=0;try{for(const n of e){const{contest:e,questions:i}=n,r=e.id,[{id:o,title:a,details:s,is_guess:c}]=i,[u,f]=s;if(tn())return t;if(c)continue;M.info(`${a} <=> ${u.odds}:${f.odds}`);const d=u.odds>f.odds;let l;l=ae.MATCH_SELECTION>0?d?f:u:d?u:f,M.info(`预测[ ${l.option} ] ${ae.MATCH_COINS} 颗硬币`),await le();const{code:p}=await en(r,o,l.detail_id,ae.MATCH_COINS);0!==p?M.info("预测失败"):(t++,se.money-=ae.MATCH_COINS)}}catch(e){console.warn(e.message)}return t}(function(e,t){return e.filter((e=>{const{questions:n}=e,[{details:i,is_guess:r}]=n;if(r)return!1;const[o,a]=i;return Math.abs(o.odds-a.odds)>=t}))}(e,ae.MATCH_DIFF));M.info(`【竞猜结束】一共参与${t}次预测`)},liveHeart:async function(){M.info("----【直播心跳】----");const{heartNum:e,fansMedalList:t}=await un(),n=t&&t.length;if(!n)return void M.info("没有勋章列表");const i=Math.ceil(e/n);for(let n=0;n<i;n++)await dn(t,e);M.info("完成")},liveLottery:async function(){M.info("----【天选时刻】----");try{const e=await async function(){const{data:e,code:t}=await It(1,1,0);if(0!==t)throw new Error(`获取最后一个关注失败: ${t}`);return e[0]}();M.info(`最后一个关注的UP: ${e.uname}`);const t=await async function(){$n=[];const e=await Tn();for(const t of e)for(const e of t)await Sn(e.areaId,e.parentId,ae.LOTTERY_PAGE_NUM);return $n}();M.info("扫描完成");const n=[];await gn(n,t,null==e?void 0:e.mid),await async function(e,t="天选时刻"){if(0===e.length)return;const n=await pn(t);if(n)for(const t of e){const{code:e,message:i}=await Ot(t.mid,n);0!==e&&M.warn(`移动【${t.uname}】失败: ${e}-${i}`),await le()}}(n),M.info("移动关注UP到分组成功")}catch(e){M.warn(`天选时刻异常: ${e.message}`),M.debug(e)}M.info("结束天选时刻")}};M.info("开始执行网络代码"),M.info("当前版本【vWed May 25 10:20:07 UTC 2022-dev】"),async function(e,...t){H.value="";try{await async function(){M.info("----【登录】----");const{data:e,message:t,code:n}=await $t();if(0!==n)throw M.error(`登录错误 ${n} ${t}`),new Error(t);if(!e.isLogin)throw new Error("接口返回为未登录");await le(),await Ct(e)}()}catch(e){return M.error(`登录失败: ${e}`),await lt("登录失败",H.value),"未完成"}const n=de([...Object.values(En)]);for(const e of n)await e(),await le();return e&&await e(...t),await lt("每日完成",H.value),"完成"}().then((e=>{VMThis.message=e,VMThis.resolve(e)})).catch((e=>{VMThis.error=e,VMThis.reject(e)}));
